(()=>{"use strict";var t,e=function(){function e(){}return e.init=function(e){var r;if(void 0!==e){if(void 0===(r=document.getElementById(e)))throw new Error("Cannot find a canvas element of id: "+e)}else r=document.createElement("canvas"),document.body.appendChild(r);if(void 0===(t=r.getContext("webgl2")))throw new Error("Unable to initilise WebGL2");return r},e}(),r="undefined"!=typeof Float32Array?Float32Array:Array;function o(){var t=new r(16);return r!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var i=function(t,e,r,o,i,n,a){var s=1/(e-r),u=1/(o-i),m=1/(n-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*m,t[11]=0,t[12]=(e+r)*s,t[13]=(i+o)*u,t[14]=(a+n)*m,t[15]=1,t};const n=function(t,e){this.Message=t,this.Handler=e},a=function(){function t(){}return t.addSubscription=function(e,r){void 0===t.m_Subscriptions[e]&&(t.m_Subscriptions[e]=[]),-1!==t.m_Subscriptions[e].indexOf(r)?console.warn("Attempting to add duplicate handler to code ".concat(e,". Subscription not added")):t.m_Subscriptions[e].push(r)},t.removeSubscription=function(e,r){if(void 0!==t.m_Subscriptions[e]){var o=t.m_Subscriptions[e].indexOf(r);-1!==o&&t.m_Subscriptions[e].splice(o,1)}else console.warn("Can't unsubscribe thandelr from code ".concat(e,", because this code is not subscribed to."))},t.post=function(e){console.log("Message posted",e),void 0!==t.m_Subscriptions[e.Code]&&t.m_Subscriptions[e.Code].forEach((function(r){e.Priority===s.HIGH?r.onMessage(e):t.m_MessageQueue.push(new n(e,r))}))},t.update=function(e){if(0!=t.m_MessageQueue.length)for(var r=Math.min(t.m_QueueLimitPerFrame,t.m_MessageQueue.length),o=0;o<r;++o){var i=t.m_MessageQueue.pop();console.log("handler",i.Handler,"node msg",i.Message),i.Handler.onMessage(i.Message)}},t.m_Subscriptions={},t.m_QueueLimitPerFrame=10,t.m_MessageQueue=[],t}();var s;!function(t){t[t.NORMAL=0]="NORMAL",t[t.HIGH=1]="HIGH"}(s||(s={}));const u=function(){function t(t,e,r,o){void 0===o&&(o=s.NORMAL),this.Code=t,this.Sender=e,this.Priority=o,this.Context=r}return t.send=function(e,r,o){a.post(new t(e,r,o))},t.sendPriority=function(e,r,o){a.post(new t(e,r,o,s.HIGH))},t.subscribe=function(t,e){a.addSubscription(t,e)},t.unsubscribe=function(t,e){a.removeSubscription(t,e)},t}();var m=function(){function t(t,e){this.Name=t,this.Data=e}return Object.defineProperty(t.prototype,"width",{get:function(){return this.Data.width},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.Data.height},enumerable:!1,configurable:!0}),t}();const c=function(){function t(){}return Object.defineProperty(t.prototype,"supportedExts",{get:function(){return["png","gif","jpg"]},enumerable:!1,configurable:!0}),t.prototype.loadAsset=function(t){var e=new Image;e.onload=this.onImageLoaded.bind(this,t,e),e.src=t},t.prototype.onImageLoaded=function(t,e){console.log("onImage loaded ".concat(t,"/").concat(e));var r=new m(t,e);p.onAssetLoaded(r)},t}();var h=function(t,e){this.Name=t,this.Data=e};const f=function(){function t(){}return Object.defineProperty(t.prototype,"supportedExts",{get:function(){return["json"]},enumerable:!1,configurable:!0}),t.prototype.loadAsset=function(t){var e=new XMLHttpRequest;e.open("GET",t),e.addEventListener("load",this.onJsonLoaded.bind(this,t,e)),e.send()},t.prototype.onJsonLoaded=function(t,e){if(console.log("onJsonLoaded loaded",t,e),e.readyState===e.DONE){var r=JSON.parse(e.responseText),o=new h(t,r);p.onAssetLoaded(o)}},t}();var d="MSG_ASSET_LOADER_ASSET_LOADED::";const p=function(){function t(){}return t.init=function(){t.m_Loaders.push(new c),t.m_Loaders.push(new f)},t.registerLoader=function(e){t.m_Loaders.push(e)},t.onAssetLoaded=function(e){t.m_LoadedAssets[e.Name]=e,u.send(d+e.Name,this,e)},t.loadAsset=function(e){for(var r=e.split(".").pop().toLowerCase(),o=0,i=t.m_Loaders;o<i.length;o++){var n=i[o];if(-1!==n.supportedExts.indexOf(r))return void n.loadAsset(e)}console.warn("Unable to load asset with extension ".concat(r,", because there is no loader associated with it."))},t.isAssetLoaded=function(e){return void 0!==t.m_LoadedAssets[e]},t.getAsset=function(e){var r=t.m_LoadedAssets[e];if(void 0!==r)return r;t.loadAsset(e)},t.m_Loaders=[],t.m_LoadedAssets={},t}();var _,l=function(){function e(t){this.m_Attributes={},this.m_Uniforms={},this.m_Name=t}return Object.defineProperty(e.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),e.prototype.load=function(e,r){var o=this.loadShader(e,t.VERTEX_SHADER),i=this.loadShader(r,t.FRAGMENT_SHADER);this.createShaderProgram(o,i),this.detectAttributes(),this.detectUniforms()},e.prototype.use=function(){t.useProgram(this.m_Program)},e.prototype.getAttributeLocation=function(t){if(void 0===this.m_Attributes[t])throw new Error("error getting attribute '".concat(t,"' :for ").concat(this.name));return this.m_Attributes[t]},e.prototype.getUniformLocation=function(t){if(void 0===this.m_Uniforms[t])throw new Error("error getting uniform '".concat(t,"' :for ").concat(this.name));return this.m_Uniforms[t]},e.prototype.loadShader=function(e,r){var o=t.createShader(r);if(t.shaderSource(o,e),t.compileShader(o),!t.getShaderParameter(o,t.COMPILE_STATUS)){var i=t.getShaderInfoLog(o);throw new Error("error compiling shader '".concat(this.m_Name,"' : ").concat(i))}return o},e.prototype.createShaderProgram=function(e,r){if(this.m_Program=t.createProgram(),t.attachShader(this.m_Program,e),t.attachShader(this.m_Program,r),t.linkProgram(this.m_Program),!t.getProgramParameter(this.m_Program,t.LINK_STATUS)){var o=t.getProgramInfoLog(this.m_Program);throw new Error("error linking shader ".concat(this.m_Name," : ").concat(o))}},e.prototype.detectAttributes=function(){for(var e=t.getProgramParameter(this.m_Program,t.ACTIVE_ATTRIBUTES),r=0;r<e;++r){var o=t.getActiveAttrib(this.m_Program,r);if(!o)break;this.m_Attributes[o.name]=t.getAttribLocation(this.m_Program,o.name)}},e.prototype.detectUniforms=function(){for(var e=t.getProgramParameter(this.m_Program,t.ACTIVE_UNIFORMS),r=0;r<e;++r){var o=t.getActiveUniform(this.m_Program,r);if(!o)break;this.m_Uniforms[o.name]=t.getUniformLocation(this.m_Program,o.name)}},e}(),y=(_=function(t,e){return _=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},_(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}_(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});const v=function(t){function e(){var e=t.call(this,"basic")||this;return e.load(e.getVertexSource(),e.getFragmentSource()),e}return y(e,t),e.prototype.getVertexSource=function(){return"#version 300 es\n\n        in vec4 a_position;\n        in vec2 a_texCoord;\n\n        uniform mat4 u_projection;\n        uniform mat4 u_model;\n\n        out vec2 v_texCoord;\n        \n        void main() {\n            gl_Position =  u_projection * u_model * a_position;\n            v_texCoord = a_texCoord;\n        }"},e.prototype.getFragmentSource=function(){return"#version 300 es\n\n        precision highp float;\n\n        uniform vec4 u_tint;\n        uniform sampler2D u_diffuse;\n\n        out vec4 outColor;\n        in vec2 v_texCoord;\n        \n        \n        void main() {\n            outColor = u_tint * texture(u_diffuse, v_texCoord);\n        }"},e}(l);var g=function(t){this.m_ReferenceCount=1,this.m_Material=t},b=function(){function t(){}return t.registerMaterial=function(e){void 0===t.m_Materials[e.name]&&(t.m_Materials[e.name]=new g(e))},t.getMaterial=function(e){return void 0===t.m_Materials[e]?void 0:(t.m_Materials[e].m_ReferenceCount++,t.m_Materials[e].m_Material)},t.releaseMaterial=function(e){void 0===t.m_Materials[e]?console.warn("Can't release material that hasn't been registered"):(t.m_Materials[e].m_ReferenceCount--,t.m_Materials[e].m_ReferenceCount<1&&(t.m_Materials[e].m_Material.destroy(),t.m_Materials[e].m_Material=void 0,delete t.m_Materials[e]))},t.m_Materials={},t}();const T=b;var w=0,A=0,S=new Uint8Array([255,255,255,255]);const x=function(){function e(e,r,o){void 0===r&&(r=1),void 0===o&&(o=1),this.m_IsLoaded=!1,this.m_Name=e,this.m_Width=r,this.m_Height=o,this.m_Handle=t.createTexture(),u.subscribe(d+this.m_Name,this),this.bind(),t.texImage2D(t.TEXTURE_2D,w,t.RGBA,1,1,A,t.RGBA,t.UNSIGNED_BYTE,S);var i=p.getAsset(this.m_Name);void 0!==i&&this.loadTextureFromAsset(i)}return e.prototype.destroy=function(){t.deleteTexture(this.m_Handle)},Object.defineProperty(e.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isLoaded",{get:function(){return this.m_IsLoaded},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this.m_Width},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.m_Height},enumerable:!1,configurable:!0}),e.prototype.bind=function(){t.bindTexture(t.TEXTURE_2D,this.m_Handle)},e.prototype.unbind=function(){t.bindTexture(t.TEXTURE_2D,void 0)},e.prototype.activateAndBind=function(e){void 0===e&&(e=0),t.activeTexture(t.TEXTURE0+e),this.bind()},e.prototype.onMessage=function(t){t.Code===d+this.m_Name&&(console.debug(this.m_Name+" loaded:",t.Context),this.loadTextureFromAsset(t.Context))},e.prototype.loadTextureFromAsset=function(e){this.m_Width=e.width,this.m_Height=e.height,this.bind(),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,w,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e.Data),this.m_IsLoaded=!0},e}();var O=function(t){this.ReferenceNode=1,this.Texture=t};const P=function(){function t(){}return t.getTexture=function(e){if(void 0===t.m_Textures[e]){var r=new x(e);t.m_Textures[e]=new O(r)}else t.m_Textures[e].ReferenceNode++;return t.m_Textures[e].Texture},t.releaseTexture=function(e){t.m_Textures[e],void 0===t.m_Textures[e]?console.warn("A texture name ".concat(e," doesn't exist, hence can't be released")):(t.m_Textures[e].ReferenceNode--,t.m_Textures[e].ReferenceNode<1&&(t.m_Textures[e].Texture.destroy(),t.m_Textures[e]=void 0,delete t.m_Textures[e]))},t.m_Textures={},t}(),L=function(){function t(t,e,r){this.m_Name=t,this.m_DiffuseTextureName=e,this.m_Tint=r,void 0!==this.m_DiffuseTextureName&&(this.m_DiffuseTexture=P.getTexture(this.m_DiffuseTextureName))}return t.prototype.destroy=function(){P.releaseTexture(this.m_DiffuseTextureName),this.m_DiffuseTexture=void 0},Object.defineProperty(t.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseTexture",{get:function(){return this.m_DiffuseTexture},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tint",{get:function(){return this.m_Tint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseTexName",{get:function(){return this.m_DiffuseTextureName},set:function(t){void 0!==this.m_DiffuseTexture&&P.releaseTexture(this.m_DiffuseTextureName),this.m_DiffuseTextureName=t,void 0!==this.m_DiffuseTextureName&&P.getTexture(this.m_DiffuseTextureName)},enumerable:!1,configurable:!0}),t}(),E=function(){function t(t,e,r,o){void 0===t&&(t=255),void 0===e&&(e=255),void 0===r&&(r=255),void 0===o&&(o=255),this.m_R=t,this.m_G=e,this.m_B=r,this.m_A=o}return Object.defineProperty(t.prototype,"r",{get:function(){return this.m_R},set:function(t){this.m_R=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rFloat",{get:function(){return this.m_R/255},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this.m_G},set:function(t){this.m_G=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gFloat",{get:function(){return this.m_G/255},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this.m_B},set:function(t){this.m_B=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bFloat",{get:function(){return this.m_B/255},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this.m_A},set:function(t){this.m_A=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"aFloat",{get:function(){return this.m_A/255},enumerable:!1,configurable:!0}),t.prototype.toArray=function(){return[this.m_R,this.m_G,this.m_B,this.m_A]},t.prototype.toFloatArray=function(){return[this.m_R/255,this.m_G/255,this.m_B/255,this.m_A/255]},t.prototype.toFloat32Array=function(){return new Float32Array(this.toFloatArray())},t.white=function(){return new t(255,255,255,255)},t.black=function(){return new t(0,0,0,255)},t.red=function(){return new t(255,0,0,255)},t.green=function(){return new t(0,255,0,255)},t.blue=function(){return new t(0,0,255,255)},t}();var F=function(){function t(t){this.m_Data=t,this.name=this.m_Data.name}return t.prototype.setOwner=function(t){this.m_Owner=t},t.prototype.update=function(t){},t.prototype.apply=function(t){},t}(),C=function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),N=function(){function t(){this.rotation=0}return t.prototype.setFromJson=function(t){if(void 0===t.name)throw new Error("Behaviour data is missing a name.");this.name=String(t.name),void 0!==t.rotation&&(this.rotation=Number(t.rotation))},t}(),M=function(){function t(){}return Object.defineProperty(t.prototype,"type",{get:function(){return"rotation"},enumerable:!1,configurable:!0}),t.prototype.buildFromJson=function(t){var e=new N;return e.setFromJson(t),new R(e)},t}(),R=function(t){function e(e){var r=t.call(this,e)||this;return r.m_Rotation=e.rotation,r}return C(e,t),e.prototype.update=function(e){this.m_Owner.Transform.Rotation+=this.m_Rotation,t.prototype.update.call(this,e)},e}(F),D=function(){function t(){}return t.init=function(){t.registerBuilder(new M)},t.registerBuilder=function(e){t.m_RegisteredBuilders[e.type]=e},t.extractBehaviour=function(e){if(void 0!==e.type){if(void 0!==t.m_RegisteredBuilders[String(e.type)])return t.m_RegisteredBuilders[String(e.type)].buildFromJson(e);throw new Error("Behaviour manager is missing type or builder is not registered for this type")}},t.m_RegisteredBuilders={},t}();function B(){var t=new r(2);return r!=Float32Array&&(t[0]=0,t[1]=0),t}function j(t,e){return t[0]=e[0],t[1]=e[1],t}function I(t,e,r){return t[0]=e,t[1]=r,t}function U(){var t=new r(3);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function G(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function H(t,e,r,o){return t[0]=e,t[1]=r,t[2]=o,t}B(),U();var V=function(){},W=function(){function e(e,r,o){switch(void 0===e&&(e=t.FLOAT),void 0===r&&(r=t.ARRAY_BUFFER),void 0===o&&(o=t.TRIANGLES),this.m_HasAttributeLocation=!1,this.m_Data=[],this.m_Attributes=[],this.m_ElementSize=0,this.m_DataType=e,this.m_TargetBufferType=r,this.m_Mode=o,this.m_DataType){case t.FLOAT:case t.INT:case t.UNSIGNED_INT:this.m_TypeSize=4;break;case t.SHORT:case t.UNSIGNED_SHORT:this.m_TypeSize=2;break;case t.BYTE:case t.UNSIGNED_BYTE:this.m_TypeSize=1;break;default:throw new Error("Unrecognised data type ".concat(e.toString()))}this.m_GLBuffer=t.createBuffer(),this.m_VAO=t.createVertexArray()}return e.prototype.destroy=function(){t.deleteBuffer(this.m_GLBuffer)},e.prototype.bind=function(e){var r=this;void 0===e&&(e=!1),t.bindVertexArray(this.m_VAO),t.bindBuffer(this.m_TargetBufferType,this.m_GLBuffer),this.m_HasAttributeLocation&&this.m_Attributes.forEach((function(o){t.vertexAttribPointer(o.location,o.size,r.m_DataType,e,r.m_Stride,o.offset*r.m_TypeSize),t.enableVertexAttribArray(o.location)}))},e.prototype.bindVAO=function(){t.bindVertexArray(this.m_VAO)},e.prototype.unbind=function(){t.bindBuffer(t.ARRAY_BUFFER,void 0),t.bindVertexArray(null)},e.prototype.addAttributeLocation=function(t){this.m_HasAttributeLocation=!0,t.offset=this.m_ElementSize,this.m_Attributes.push(t),this.m_ElementSize+=t.size,this.m_Stride=this.m_ElementSize*this.m_TypeSize},e.prototype.pushBackData=function(t){var e=this;t.forEach((function(t){e.m_Data.push(t)}))},e.prototype.clearData=function(){this.m_Data.length=0},e.prototype.setData=function(t){this.clearData(),this.pushBackData(t)},e.prototype.upload=function(){var e;switch(t.bindBuffer(this.m_TargetBufferType,this.m_GLBuffer),this.m_DataType){case t.FLOAT:e=new Float32Array(this.m_Data);break;case t.INT:e=new Int32Array(this.m_Data);break;case t.UNSIGNED_INT:e=new Uint32Array(this.m_Data);break;case t.SHORT:e=new Int16Array(this.m_Data);break;case t.UNSIGNED_SHORT:e=new Uint16Array(this.m_Data);break;case t.BYTE:e=new Int8Array(this.m_Data);break;case t.UNSIGNED_BYTE:e=new Uint8Array(this.m_Data)}t.bufferData(this.m_TargetBufferType,e,t.STATIC_DRAW)},e.prototype.draw=function(){this.m_TargetBufferType===t.ARRAY_BUFFER?t.drawArrays(this.m_Mode,0,this.m_Data.length/this.m_ElementSize):this.m_TargetBufferType===t.ELEMENT_ARRAY_BUFFER&&t.drawElements(this.m_Mode,this.m_Data.length,this.m_DataType,0)},e}();const k=function(){function t(t,e,r,o,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===i&&(i=0),this.Position=U(),this.TexCoords=B(),H(this.Position,t,e,r),I(this.TexCoords,o,i)}return t.prototype.toArray=function(){var t,e,r=[];return t=[this.Position[0],this.Position[1],this.Position[2]],r=r.concat(t),e=[this.TexCoords[0],this.TexCoords[1]],r.concat(e)},t.prototype.toFloat32Arr=function(){return new Float32Array(this.toArray())},t}();const z=function(){function e(t,e,r,i){void 0===r&&(r=100),void 0===i&&(i=100),this.m_Vertices=[],this.m_Position=U(),this.m_Name=t,this.m_Height=i,this.m_Width=r,this.m_MaterialName=e,this.m_Material=T.getMaterial(this.m_MaterialName),this.m_Model=o()}return e.prototype.destroy=function(){this.m_Buffer.destroy(),T.releaseMaterial(this.m_MaterialName),this.m_Material=void 0,this.m_MaterialName=void 0},Object.defineProperty(e.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),e.prototype.load=function(){this.m_Buffer=new W;var t=new V;t.location=0,t.size=3,this.m_Buffer.addAttributeLocation(t);var e=new V;e.location=1,e.size=2,this.m_Buffer.addAttributeLocation(e),this.m_Buffer.bind(),this.m_Vertices=[new k(0,0,0,0,0),new k(0,this.m_Height,0,0,1),new k(this.m_Width,this.m_Height,0,1,1),new k(this.m_Width,this.m_Height,0,1,1),new k(this.m_Width,0,0,1,0),new k(0,0,0,0,0)];for(var r=0,o=this.m_Vertices;r<o.length;r++){var i=o[r];this.m_Buffer.pushBackData(i.toArray())}this.m_Buffer.upload(),this.m_Buffer.unbind()},e.prototype.update=function(t){},e.prototype.draw=function(e,r){var o=e.getUniformLocation("u_model");t.uniformMatrix4fv(o,!1,r);var i=e.getUniformLocation("u_tint");if(t.uniform4fv(i,this.m_Material.tint.toFloat32Array()),void 0!==this.m_Material.diffuseTexture){this.m_Material.diffuseTexture.activateAndBind(0);var n=e.getUniformLocation("u_diffuse");t.uniform1i(n,0)}this.m_Buffer.bindVAO(),this.m_Buffer.draw()},e}();var J=function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),X=function(t,e){this.Max=e,this.Min=t};const q=function(t){function e(e,r,o,i,n,a,s,m){void 0===o&&(o=100),void 0===i&&(i=100),void 0===n&&(n=10),void 0===a&&(a=10),void 0===s&&(s=1),void 0===m&&(m=[]);var c=t.call(this,e,r,o,i)||this;return c.m_FrameTime=333,c.m_FrameUVs=[],c.m_CurrentFrame=0,c.m_CurrentTime=0,c.m_AssetWidth=2,c.m_AssetHeight=2,c.m_AssetLoaded=!1,c.m_FrameWidth=n,c.m_FrameHeight=a,c.m_FrameCount=s,c.m_FrameSequance=m,u.subscribe(d+c.m_Material.diffuseTexName,c),c}return J(e,t),e.prototype.onMessage=function(t){if(console.log("Called"),t.Code===d+this.m_Material.diffuseTexName){this.m_AssetLoaded=!0;var e=t.Context;this.m_AssetWidth=e.width,this.m_AssetHeight=e.height,this.calculateUVs()}},e.prototype.destroy=function(){t.prototype.destroy.call(this)},e.prototype.load=function(){t.prototype.load.call(this)},e.prototype.update=function(e){if(this.m_AssetLoaded){if(this.m_CurrentTime+=e,this.m_CurrentTime>this.m_FrameTime){this.m_CurrentFrame++,this.m_CurrentTime=0,this.m_CurrentFrame>=this.m_FrameSequance.length&&(this.m_CurrentFrame=0);var r=this.m_FrameSequance[this.m_CurrentFrame];j(this.m_Vertices[0].TexCoords,this.m_FrameUVs[r].Min),I(this.m_Vertices[1].TexCoords,this.m_FrameUVs[r].Min[0],this.m_FrameUVs[r].Max[1]),j(this.m_Vertices[2].TexCoords,this.m_FrameUVs[r].Max),j(this.m_Vertices[3].TexCoords,this.m_FrameUVs[r].Max),I(this.m_Vertices[4].TexCoords,this.m_FrameUVs[r].Max[0],this.m_FrameUVs[r].Min[1]),j(this.m_Vertices[5].TexCoords,this.m_FrameUVs[r].Min),this.m_Buffer.clearData();for(var o=0,i=this.m_Vertices;o<i.length;o++){var n=i[o];this.m_Buffer.pushBackData(n.toArray())}this.m_Buffer.upload(),this.m_Buffer.unbind()}t.prototype.update.call(this,e)}},e.prototype.calculateUVs=function(){for(var t=0,e=0,r=0;r<this.m_FrameCount;++r){(t+=r*this.m_FrameWidth)>this.m_Width&&(e++,t=0),console.log("w/h",this.m_AssetWidth,this.m_AssetHeight);var o=this.m_AssetWidth,i=this.m_AssetHeight,n=r*this.m_FrameWidth/o,a=e*this.m_FrameHeight/i,s=I(B(),n,a),u=r*this.m_FrameWidth+this.m_FrameWidth/o,m=e*this.m_FrameHeight+this.m_FrameHeight/i,c=I(B(),u,m);this.m_FrameUVs.push(new X(s,c))}},e}(z),Y=function(){function t(t){this.m_Data=t,this.name=t.name}return Object.defineProperty(t.prototype,"owner",{get:function(){return this.m_Owner},enumerable:!1,configurable:!0}),t.prototype.setOwner=function(t){this.m_Owner=t},t.prototype.load=function(){},t.prototype.update=function(t){},t.prototype.render=function(t){},t}();var Q=function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),K=function(){function t(){}return t.prototype.setFromJson=function(t){void 0!==t.name&&(this.name=String(t.name)),void 0!==t.name&&(this.materialName=String(t.materialName))},t}(),Z=function(){function t(){}return Object.defineProperty(t.prototype,"type",{get:function(){return"sprite"},enumerable:!1,configurable:!0}),t.prototype.buildFromJson=function(t){var e=new K;return e.setFromJson(t),new $(e)},t}(),$=function(t){function e(e){var r=t.call(this,e)||this;return r.m_Sprite=new z(r.name,e.materialName),r}return Q(e,t),e.prototype.load=function(){this.m_Sprite.load()},e.prototype.render=function(e){this.m_Sprite.draw(e,this.m_Owner.worldMatrix),t.prototype.render.call(this,e)},e}(Y),tt=function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),et=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.FrameSequence=[],e}return tt(e,t),e.prototype.setFromJson=function(e){if(t.prototype.setFromJson.call(this,e),void 0===e.FrameWidth)throw new Error("AnimatedSpriteComponent is missng FrameWidth");if(this.FrameWidth=Number(e.FrameWidth),void 0===e.FrameHeight)throw new Error("AnimatedSpriteComponent is missng FrameHeight");if(this.FrameHeight=Number(e.FrameHeight),void 0===e.FrameCount)throw new Error("AnimatedSpriteComponent is missng FrameCount");if(this.FrameCount=Number(e.FrameCount),void 0===e.FrameSequence)throw new Error("AnimatedSpriteComponent is missng FrameSequence");this.FrameSequence=e.FrameSequence},e}(K),rt=function(){function t(){}return Object.defineProperty(t.prototype,"type",{get:function(){return"animatedSprite"},enumerable:!1,configurable:!0}),t.prototype.buildFromJson=function(t){var e=new et;return e.setFromJson(t),new ot(e)},t}(),ot=function(t){function e(e){var r=t.call(this,e)||this;return r.m_Sprite=new q(r.name,e.materialName,e.FrameWidth,e.FrameHeight,e.FrameWidth,e.FrameHeight,e.FrameCount,e.FrameSequence),r}return tt(e,t),e.prototype.load=function(){this.m_Sprite.load()},e.prototype.update=function(e){t.prototype.update.call(this,e),this.m_Sprite.update(e)},e.prototype.render=function(e){this.m_Sprite.draw(e,this.m_Owner.worldMatrix),t.prototype.render.call(this,e)},e}(Y),it=function(){function t(){}return t.init=function(){t.registerBuilder(new Z),t.registerBuilder(new rt)},t.registerBuilder=function(e){t.m_RegisteredBuilders[e.type]=e},t.extractComponent=function(e){if(void 0!==e.type){if(void 0!==t.m_RegisteredBuilders[String(e.type)])return t.m_RegisteredBuilders[String(e.type)].buildFromJson(e);throw new Error("Component manager is missing type or builder is not registered for this type")}},t.m_RegisteredBuilders={},t}(),nt=function(){function t(){this.Position=U(),this.Rotation=0,this.Scale=H(U(),1,1,1)}return t.prototype.copyFrom=function(t){G(this.Position,t.Position),this.Rotation=t.Rotation,G(this.Scale,t.Scale)},t.prototype.getTransformationMatrix=function(){var t,e,r,i,n,a,s,u,m,c,h,f,d,p,_,l,y,v,g=(t=o(),e=o(),l=(r=this.Position)[0],y=r[1],v=r[2],e===t?(t[12]=e[0]*l+e[4]*y+e[8]*v+e[12],t[13]=e[1]*l+e[5]*y+e[9]*v+e[13],t[14]=e[2]*l+e[6]*y+e[10]*v+e[14],t[15]=e[3]*l+e[7]*y+e[11]*v+e[15]):(i=e[0],n=e[1],a=e[2],s=e[3],u=e[4],m=e[5],c=e[6],h=e[7],f=e[8],d=e[9],p=e[10],_=e[11],t[0]=i,t[1]=n,t[2]=a,t[3]=s,t[4]=u,t[5]=m,t[6]=c,t[7]=h,t[8]=f,t[9]=d,t[10]=p,t[11]=_,t[12]=i*l+u*y+f*v+e[12],t[13]=n*l+m*y+d*v+e[13],t[14]=a*l+c*y+p*v+e[14],t[15]=s*l+h*y+_*v+e[15]),t);return function(t,e,r){var o=Math.sin(r),i=Math.cos(r),n=e[0],a=e[1],s=e[2],u=e[3],m=e[4],c=e[5],h=e[6],f=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*i+m*o,t[1]=a*i+c*o,t[2]=s*i+h*o,t[3]=u*i+f*o,t[4]=m*i-n*o,t[5]=c*i-a*o,t[6]=h*i-s*o,t[7]=f*i-u*o}(g,g,this.Rotation),function(t,e,r){var o=r[0],i=r[1],n=r[2];t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t[3]=e[3]*o,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(g,g,this.Scale),g},t.prototype.setFromJson=function(t){void 0!==t.position&&H(this.Position,t.position.x,t.position.y,t.position.z),void 0!==t.rotation&&(this.Rotation=t.rotation),void 0!==t.scale&&H(this.Scale,t.scale.x,t.scale.y,t.scale.z)},t}();const at=nt;var st=function(){function t(t,e,r){this.m_Children=[],this.m_IsLoaded=!1,this.m_LocalMatrix=o(),this.m_WorldMatrix=o(),this.m_Components=[],this.m_Behaviours=[],this.Transform=new at,this.m_Id=t,this.Name=e,this.m_Scene=r}return Object.defineProperty(t.prototype,"id",{get:function(){return this.m_Id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this.m_Parent},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldMatrix",{get:function(){return this.m_WorldMatrix},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isLoaded",{get:function(){return this.m_IsLoaded},enumerable:!1,configurable:!0}),t.prototype.addChild=function(t){t.m_Parent=this,this.m_Children.push(t),t.onAdded(this.m_Scene)},t.prototype.removeChild=function(t){var e=this.m_Children.indexOf(t);-1!==e&&(t.m_Parent=void 0,this.m_Children.splice(e,1))},t.prototype.getObjectByName=function(t){if(this.Name===t)return this;for(var e=0,r=this.m_Children;e<r.length;e++){var o=r[e].getObjectByName(t);if(void 0!==o)return o}},t.prototype.addComponent=function(t){this.m_Components.push(t),t.setOwner(this)},t.prototype.addBehaviour=function(t){this.m_Behaviours.push(t),t.setOwner(this)},t.prototype.load=function(){this.m_IsLoaded=!0;for(var t=0,e=this.m_Components;t<e.length;t++)e[t].load();for(var r=0,o=this.m_Children;r<o.length;r++)o[r].load()},t.prototype.update=function(t){this.m_LocalMatrix=this.Transform.getTransformationMatrix(),this.updateWorldMatrix(void 0!==this.m_Parent?this.m_Parent.worldMatrix:void 0);for(var e=0,r=this.m_Components;e<r.length;e++)r[e].update(t);for(var o=0,i=this.m_Behaviours;o<i.length;o++)i[o].update(t);for(var n=0,a=this.m_Children;n<a.length;n++)a[n].update(t)},t.prototype.render=function(t){for(var e=0,r=this.m_Components;e<r.length;e++)r[e].render(t);for(var o=0,i=this.m_Children;o<i.length;o++)i[o].render(t)},t.prototype.updateWorldMatrix=function(t){var e,r;void 0!==t?function(t,e,r){var o=e[0],i=e[1],n=e[2],a=e[3],s=e[4],u=e[5],m=e[6],c=e[7],h=e[8],f=e[9],d=e[10],p=e[11],_=e[12],l=e[13],y=e[14],v=e[15],g=r[0],b=r[1],T=r[2],w=r[3];t[0]=g*o+b*s+T*h+w*_,t[1]=g*i+b*u+T*f+w*l,t[2]=g*n+b*m+T*d+w*y,t[3]=g*a+b*c+T*p+w*v,g=r[4],b=r[5],T=r[6],w=r[7],t[4]=g*o+b*s+T*h+w*_,t[5]=g*i+b*u+T*f+w*l,t[6]=g*n+b*m+T*d+w*y,t[7]=g*a+b*c+T*p+w*v,g=r[8],b=r[9],T=r[10],w=r[11],t[8]=g*o+b*s+T*h+w*_,t[9]=g*i+b*u+T*f+w*l,t[10]=g*n+b*m+T*d+w*y,t[11]=g*a+b*c+T*p+w*v,g=r[12],b=r[13],T=r[14],w=r[15],t[12]=g*o+b*s+T*h+w*_,t[13]=g*i+b*u+T*f+w*l,t[14]=g*n+b*m+T*d+w*y,t[15]=g*a+b*c+T*p+w*v}(this.worldMatrix,t,this.m_LocalMatrix):(e=this.m_WorldMatrix,r=this.m_LocalMatrix,e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15])},t.prototype.onAdded=function(t){this.m_Scene=t},t}();const ut=st;const mt=function(){function t(){this.m_RootObj=new ut(0,"__ROOT__",this)}return Object.defineProperty(t.prototype,"root",{get:function(){return this.m_RootObj},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isLoaded",{get:function(){return this.m_RootObj.isLoaded},enumerable:!1,configurable:!0}),t.prototype.addObject=function(t){this.m_RootObj.addChild(t)},t.prototype.getObjectByName=function(t){return this.m_RootObj.getObjectByName(t)},t.prototype.load=function(){this.m_RootObj.load()},t.prototype.update=function(t){this.m_RootObj.update(t)},t.prototype.render=function(t){this.m_RootObj.render(t)},t}();var ct;!function(t){t[t.UNINITILISED=0]="UNINITILISED",t[t.LOADING=1]="LOADING",t[t.UPDATING=2]="UPDATING"}(ct||(ct={}));var ht=function(){function t(t,e,r){this.m_State=ct.UNINITILISED,this.m_GlobalId=-1,this.m_Id=t,this.m_Descritpion=r,this.m_Name=e,this.m_Scene=new mt}return Object.defineProperty(t.prototype,"id",{get:function(){return this.m_Id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"description",{get:function(){return this.m_Descritpion},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scene",{get:function(){return this.m_Scene},enumerable:!1,configurable:!0}),t.prototype.init=function(t){if(void 0===t.objects)throw new Error("Level init error: objects are missing");for(var e in t.objects){var r=t.objects[e];this.loadSimObject(r,this.m_Scene.root)}},t.prototype.load=function(){this.m_State=ct.LOADING,this.m_Scene.load(),this.m_State=ct.UPDATING},t.prototype.unload=function(){},t.prototype.update=function(t){this.m_State===ct.UPDATING&&this.m_Scene.update(t)},t.prototype.render=function(t){this.m_State===ct.UPDATING&&this.m_Scene.render(t)},t.prototype.onActivated=function(){},t.prototype.onDeactived=function(){},t.prototype.loadSimObject=function(t,e){var r;void 0!==t.name&&(r=String(t.name)),this.m_GlobalId++;var o=new ut(this.m_GlobalId,r,this.m_Scene);if(void 0!==t.transform&&o.Transform.setFromJson(t.transform),void 0!==t.components)for(var i in t.components){var n=t.components[i],a=it.extractComponent(n);console.log(a),o.addComponent(a)}if(void 0!==t.behaviours)for(var s in t.behaviours){n=t.behaviours[s];var u=D.extractBehaviour(n);o.addBehaviour(u)}if(void 0!==t.children)for(var m in t.children){var c=t.children[m];this.loadSimObject(c,o)}void 0!==e&&e.addChild(o)},t}();const ft=ht;const dt=function(){function t(){}return t.init=function(){t.m_Instance=new t,t.m_RegisteredLevels[0]="../../assets/levels/testLevel.json"},t.changeLevel=function(e){if(void 0!==t.m_ActiveLevel&&(t.m_ActiveLevel.onDeactived(),t.m_ActiveLevel.unload(),t.m_ActiveLevel=void 0),void 0===t.m_RegisteredLevels[e])throw new Error("Level with id ".concat(e," doesn't exist."));if(p.isAssetLoaded(t.m_RegisteredLevels[e])){var r=p.getAsset(t.m_RegisteredLevels[e]);t.loadLevel(r)}else u.subscribe(d+t.m_RegisteredLevels[e],t.m_Instance),p.loadAsset(t.m_RegisteredLevels[e])},t.update=function(e){void 0!==t.m_ActiveLevel&&t.m_ActiveLevel.update(e)},t.render=function(e){void 0!==t.m_ActiveLevel&&t.m_ActiveLevel.render(e)},t.loadLevel=function(e){var r,o,i,n=e.Data;if(void 0===n.id)throw new Error("Level id missing");if(r=Number(n.id),void 0===n.name)throw new Error("Level name missing");o=String(n.name),void 0!==n.description&&(i=String(n.description)),t.m_ActiveLevel=new ft(r,o,i),t.m_ActiveLevel.init(n),t.m_ActiveLevel.onActivated(),t.m_ActiveLevel.load()},t.prototype.onMessage=function(e){if(-1!==e.Code.indexOf(d)){var r=e.Context;t.loadLevel(r)}},t.m_GlobalLevelId=-1,t.m_RegisteredLevels={},t}(),pt=function(){function r(){this.m_PreviousTime=0}return r.prototype.start=function(){this.m_Canvas=e.init(),p.init(),dt.init(),it.init(),D.init(),t.clearColor(0,0,0,1),this.m_BasicShader=new v,this.m_BasicShader.use(),this.m_Projection=o(),this.m_Projection=i(this.m_Projection,0,this.m_Canvas.width,this.m_Canvas.height,0,-100,100),T.registerMaterial(new L("crate","../assets/textures/crate.jpg",new E(255,255,255,255))),T.registerMaterial(new L("duck","../assets/textures/duck.png",new E(255,255,255,255))),dt.changeLevel(0),this.resize(),this.loop()},r.prototype.resize=function(){void 0!==this.m_Canvas&&(this.m_Canvas.width=window.innerWidth,this.m_Canvas.height=window.innerHeight),t.viewport(0,0,this.m_Canvas.width,this.m_Canvas.height),this.m_Projection=i(this.m_Projection,0,this.m_Canvas.width,this.m_Canvas.height,0,-100,100)},r.prototype.loop=function(){this.update(),this.render()},r.prototype.update=function(){var t=performance.now()-this.m_PreviousTime;a.update(t),dt.update(t),this.m_PreviousTime=performance.now()},r.prototype.render=function(){t.clear(t.COLOR_BUFFER_BIT);var e=this.m_BasicShader.getUniformLocation("u_projection");t.uniformMatrix4fv(e,!1,new Float32Array(this.m_Projection)),dt.render(this.m_BasicShader),requestAnimationFrame(this.loop.bind(this))},r}();var _t;window.onload=function(){(_t=new pt).start()},window.onresize=function(){_t.resize()}})();