(()=>{"use strict";var t=function(){function t(){}return t.registerBuilder=function(e){console.log("registerBuilder called "),t.m_RegisteredBuilders[e.type]=e},t.extractComponent=function(e){if(void 0!==e.type){if(console.log("Builders: ",t.m_RegisteredBuilders[String(e.type)]),void 0!==t.m_RegisteredBuilders[String(e.type)])return t.m_RegisteredBuilders[String(e.type)].buildFromJson(e);throw new Error("Component manager is missing type or builder is not registered for this type")}},t.m_RegisteredBuilders={},t}(),e="undefined"!=typeof Float32Array?Float32Array:Array;function r(){var t=new e(3);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function n(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function o(){var t=new e(16);return e!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),r();var i,a=function(t,e,r,n,o,i,a){var s=1/(e-r),u=1/(n-o),c=1/(i-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+r)*s,t[13]=(o+n)*u,t[14]=(a+i)*c,t[15]=1,t},s=function(){function t(){}return t.init=function(t){var e;if(void 0!==t){if(void 0===(e=document.getElementById(t)))throw new Error("Cannot find a canvas element of id: "+t)}else e=document.createElement("canvas"),document.body.appendChild(e);if(void 0===(i=e.getContext("webgl2")))throw new Error("Unable to initilise WebGL2");return e},t}(),u=function(){},c=function(){function t(t,e,r,n){switch(void 0===e&&(e=i.FLOAT),void 0===r&&(r=i.ARRAY_BUFFER),void 0===n&&(n=i.TRIANGLES),this.m_HasAttributeLocation=!1,this.m_Data=[],this.m_Attributes=[],this.m_ElementSize=t,this.m_DataType=e,this.m_TargetBufferType=r,this.m_Mode=n,this.m_DataType){case i.FLOAT:case i.INT:case i.UNSIGNED_INT:this.m_TypeSize=4;break;case i.SHORT:case i.UNSIGNED_SHORT:this.m_TypeSize=2;break;case i.BYTE:case i.UNSIGNED_BYTE:this.m_TypeSize=1;break;default:throw new Error("Unrecognised data type ".concat(e.toString()))}this.m_Stride=this.m_ElementSize*this.m_TypeSize,this.m_GLBuffer=i.createBuffer(),this.m_VAO=i.createVertexArray()}return t.prototype.destroy=function(){i.deleteBuffer(this.m_GLBuffer)},t.prototype.bind=function(t){var e=this;void 0===t&&(t=!1),i.bindVertexArray(this.m_VAO),i.bindBuffer(this.m_TargetBufferType,this.m_GLBuffer),this.m_HasAttributeLocation&&this.m_Attributes.forEach((function(r){i.vertexAttribPointer(r.location,r.size,e.m_DataType,t,e.m_Stride,r.offset*e.m_TypeSize),i.enableVertexAttribArray(r.location)}))},t.prototype.bindVAO=function(){i.bindVertexArray(this.m_VAO)},t.prototype.unbind=function(){i.bindBuffer(i.ARRAY_BUFFER,void 0),i.bindVertexArray(null)},t.prototype.addAttributeLocation=function(t){this.m_HasAttributeLocation=!0,this.m_Attributes.push(t)},t.prototype.pushBackData=function(t){var e=this;t.forEach((function(t){e.m_Data.push(t)}))},t.prototype.upload=function(){var t;switch(i.bindBuffer(this.m_TargetBufferType,this.m_GLBuffer),this.m_DataType){case i.FLOAT:t=new Float32Array(this.m_Data);break;case i.INT:t=new Int32Array(this.m_Data);break;case i.UNSIGNED_INT:t=new Uint32Array(this.m_Data);break;case i.SHORT:t=new Int16Array(this.m_Data);break;case i.UNSIGNED_SHORT:t=new Uint16Array(this.m_Data);break;case i.BYTE:t=new Int8Array(this.m_Data);break;case i.UNSIGNED_BYTE:t=new Uint8Array(this.m_Data)}i.bufferData(this.m_TargetBufferType,t,i.STATIC_DRAW)},t.prototype.draw=function(){this.m_TargetBufferType===i.ARRAY_BUFFER?i.drawArrays(this.m_Mode,0,this.m_Data.length/this.m_ElementSize):this.m_TargetBufferType===i.ELEMENT_ARRAY_BUFFER&&i.drawElements(this.m_Mode,this.m_Data.length,this.m_DataType,0)},t}(),m=function(t){this.m_ReferenceCount=1,this.m_Material=t},f=function(){function t(){}return t.registerMaterial=function(e){void 0===t.m_Materials[e.name]&&(t.m_Materials[e.name]=new m(e))},t.getMaterial=function(e){return void 0===t.m_Materials[e]?void 0:(t.m_Materials[e].m_ReferenceCount++,t.m_Materials[e].m_Material)},t.releaseMaterial=function(e){void 0===t.m_Materials[e]?console.warn("Can't release material that hasn't been registered"):(t.m_Materials[e].m_ReferenceCount--,t.m_Materials[e].m_ReferenceCount<1&&(t.m_Materials[e].m_Material.destroy(),t.m_Materials[e].m_Material=void 0,delete t.m_Materials[e]))},t.m_Materials={},t}();const d=f;var h=function(){function t(t,e,n,i){void 0===n&&(n=100),void 0===i&&(i=100),this.m_Position=r(),this.m_Name=t,this.m_Height=i,this.m_Width=n,this.m_MaterialName=e,this.m_Material=d.getMaterial(this.m_MaterialName),this.m_Model=o()}return t.prototype.destroy=function(){this.m_Buffer.destroy(),d.releaseMaterial(this.m_MaterialName),this.m_Material=void 0,this.m_MaterialName=void 0},Object.defineProperty(t.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),t.prototype.load=function(){this.m_Buffer=new c(5);var t=new u;t.location=0,t.size=3,t.offset=0,this.m_Buffer.addAttributeLocation(t);var e=new u;e.location=1,e.size=2,e.offset=3,this.m_Buffer.addAttributeLocation(e),this.m_Buffer.bind();var r=[0,0,0,0,0,0,this.m_Height,0,0,1,this.m_Width,this.m_Height,0,1,1,this.m_Width,this.m_Height,0,1,1,this.m_Width,0,0,1,0,0,0,0,0,0];this.m_Buffer.pushBackData(r),this.m_Buffer.upload(),this.m_Buffer.unbind()},t.prototype.update=function(t){},t.prototype.draw=function(t,e){var r=t.getUniformLocation("u_model");i.uniformMatrix4fv(r,!1,e);var n=t.getUniformLocation("u_tint");if(i.uniform4fv(n,this.m_Material.tint.toFloat32Array()),void 0!==this.m_Material.diffuseTexture){this.m_Material.diffuseTexture.activateAndBind(0);var o=t.getUniformLocation("u_diffuse");i.uniform1i(o,0)}this.m_Buffer.bindVAO(),this.m_Buffer.draw()},t}();const _=h,p=function(){function t(t){this.m_Data=t,this.name=t.name}return Object.defineProperty(t.prototype,"owner",{get:function(){return this.m_Owner},enumerable:!1,configurable:!0}),t.prototype.setOwner=function(t){this.m_Owner=t},t.prototype.load=function(){},t.prototype.update=function(t){},t.prototype.render=function(t){},t}();var l,g=(l=function(t,e){return l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},l(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}l(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),v=function(){function t(){}return t.prototype.setFromJson=function(t){void 0!==t.name&&(this.name=String(t.name)),void 0!==t.name&&(this.materialName=String(t.materialName))},t}(),b=function(){function t(){}return Object.defineProperty(t.prototype,"type",{get:function(){return"sprite"},enumerable:!1,configurable:!0}),t.prototype.buildFromJson=function(t){var e=new v;return e.setFromJson(t),new y(e)},t}(),y=function(t){function e(e){var r=t.call(this,e)||this;return r.m_Sprite=new _(r.name,e.materialName),r}return g(e,t),e.prototype.load=function(){this.m_Sprite.load()},e.prototype.render=function(e){this.m_Sprite.draw(e,this.m_Owner.worldMatrix),t.prototype.render.call(this,e)},e}(p);t.registerBuilder(new b);const T=function(t,e){this.Message=t,this.Handler=e},A=function(){function t(){}return t.addSubscription=function(e,r){void 0===t.m_Subscriptions[e]&&(t.m_Subscriptions[e]=[]),-1!==t.m_Subscriptions[e].indexOf(r)?console.warn("Attempting to add duplicate handler to code ".concat(e,". Subscription not added")):t.m_Subscriptions[e].push(r)},t.removeSubscription=function(e,r){if(void 0!==t.m_Subscriptions[e]){var n=t.m_Subscriptions[e].indexOf(r);-1!==n&&t.m_Subscriptions[e].splice(n,1)}else console.warn("Can't unsubscribe thandelr from code ".concat(e,", because this code is not subscribed to."))},t.post=function(e){console.log("Message posted",e),void 0!==t.m_Subscriptions[e.Code]&&t.m_Subscriptions[e.Code].forEach((function(r){e.Priority===w.HIGH?r.onMessage(e):t.m_MessageQueue.push(new T(e,r))}))},t.update=function(e){if(0!=t.m_MessageQueue.length)for(var r=Math.min(t.m_QueueLimitPerFrame,t.m_MessageQueue.length),n=0;n<r;++n){var o=t.m_MessageQueue.pop();o.Handler.onMessage(o.Message)}},t.m_Subscriptions={},t.m_QueueLimitPerFrame=10,t.m_MessageQueue=[],t}();var w;!function(t){t[t.NORMAL=0]="NORMAL",t[t.HIGH=1]="HIGH"}(w||(w={}));const S=function(){function t(t,e,r,n){void 0===n&&(n=w.NORMAL),this.Code=t,this.Sender=e,this.Priority=n,this.Context=r}return t.send=function(e,r,n){A.post(new t(e,r,n))},t.sendPriority=function(e,r,n){A.post(new t(e,r,n,w.HIGH))},t.subscribe=function(t,e){A.addSubscription(t,e)},t.unsubscribe=function(t,e){A.removeSubscription(t,e)},t}();var L=function(){function t(t,e){this.Name=t,this.Data=e}return Object.defineProperty(t.prototype,"width",{get:function(){return this.Data.width},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.Data.height},enumerable:!1,configurable:!0}),t}();const x=function(){function t(){}return Object.defineProperty(t.prototype,"supportedExts",{get:function(){return["png","gif","jpg"]},enumerable:!1,configurable:!0}),t.prototype.loadAsset=function(t){var e=new Image;e.onload=this.onImageLoaded.bind(this,t,e),e.src=t},t.prototype.onImageLoaded=function(t,e){console.log("onImage loaded ".concat(t,"/").concat(e));var r=new L(t,e);N.onAssetLoaded(r)},t}();var P=function(t,e){this.Name=t,this.Data=e};const E=function(){function t(){}return Object.defineProperty(t.prototype,"supportedExts",{get:function(){return["json"]},enumerable:!1,configurable:!0}),t.prototype.loadAsset=function(t){var e=new XMLHttpRequest;e.open("GET",t),e.addEventListener("load",this.onJsonLoaded.bind(this,t,e)),e.send()},t.prototype.onJsonLoaded=function(t,e){if(console.log("onJsonLoaded loaded",t,e),e.readyState===e.DONE){var r=JSON.parse(e.responseText),n=new P(t,r);N.onAssetLoaded(n)}},t}();var O="MSG_ASSET_LOADER_ASSET_LOADED::";const N=function(){function t(){}return t.init=function(){t.m_Loaders.push(new x),t.m_Loaders.push(new E)},t.registerLoader=function(e){t.m_Loaders.push(e)},t.onAssetLoaded=function(e){t.m_LoadedAssets[e.Name]=e,S.send(O+e.Name,this,e)},t.loadAsset=function(e){for(var r=e.split(".").pop().toLowerCase(),n=0,o=t.m_Loaders;n<o.length;n++){var i=o[n];if(-1!==i.supportedExts.indexOf(r))return void i.loadAsset(e)}console.warn("Unable to load asset with extension ".concat(r,", because there is no loader associated with it."))},t.isAssetLoaded=function(e){return void 0!==t.m_LoadedAssets[e]},t.getAsset=function(e){var r=t.m_LoadedAssets[e];if(void 0!==r)return r;t.loadAsset(e)},t.m_Loaders=[],t.m_LoadedAssets={},t}();var R=function(){function t(t){this.m_Attributes={},this.m_Uniforms={},this.m_Name=t}return Object.defineProperty(t.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),t.prototype.load=function(t,e){var r=this.loadShader(t,i.VERTEX_SHADER),n=this.loadShader(e,i.FRAGMENT_SHADER);this.createShaderProgram(r,n),this.detectAttributes(),this.detectUniforms()},t.prototype.use=function(){i.useProgram(this.m_Program)},t.prototype.getAttributeLocation=function(t){if(void 0===this.m_Attributes[t])throw new Error("error getting attribute '".concat(t,"' :for ").concat(this.name));return this.m_Attributes[t]},t.prototype.getUniformLocation=function(t){if(void 0===this.m_Uniforms[t])throw new Error("error getting uniform '".concat(t,"' :for ").concat(this.name));return this.m_Uniforms[t]},t.prototype.loadShader=function(t,e){var r=i.createShader(e);if(i.shaderSource(r,t),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){var n=i.getShaderInfoLog(r);throw new Error("error compiling shader '".concat(this.m_Name,"' : ").concat(n))}return r},t.prototype.createShaderProgram=function(t,e){if(this.m_Program=i.createProgram(),i.attachShader(this.m_Program,t),i.attachShader(this.m_Program,e),i.linkProgram(this.m_Program),!i.getProgramParameter(this.m_Program,i.LINK_STATUS)){var r=i.getProgramInfoLog(this.m_Program);throw new Error("error linking shader ".concat(this.m_Name," : ").concat(r))}},t.prototype.detectAttributes=function(){for(var t=i.getProgramParameter(this.m_Program,i.ACTIVE_ATTRIBUTES),e=0;e<t;++e){var r=i.getActiveAttrib(this.m_Program,e);if(!r)break;this.m_Attributes[r.name]=i.getAttribLocation(this.m_Program,r.name)}},t.prototype.detectUniforms=function(){for(var t=i.getProgramParameter(this.m_Program,i.ACTIVE_UNIFORMS),e=0;e<t;++e){var r=i.getActiveUniform(this.m_Program,e);if(!r)break;this.m_Uniforms[r.name]=i.getUniformLocation(this.m_Program,r.name)}},t}();const M=R;var D=function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();const I=function(t){function e(){var e=t.call(this,"basic")||this;return e.load(e.getVertexSource(),e.getFragmentSource()),e}return D(e,t),e.prototype.getVertexSource=function(){return"#version 300 es\n\n        in vec4 a_position;\n        in vec2 a_texCoord;\n\n        uniform mat4 u_projection;\n        uniform mat4 u_model;\n\n        out vec2 v_texCoord;\n        \n        void main() {\n            gl_Position =  u_projection * u_model * a_position;\n            v_texCoord = a_texCoord;\n        }"},e.prototype.getFragmentSource=function(){return"#version 300 es\n\n        precision highp float;\n\n        uniform vec4 u_tint;\n        uniform sampler2D u_diffuse;\n\n        out vec4 outColor;\n        in vec2 v_texCoord;\n        \n        \n        void main() {\n            outColor = u_tint * texture(u_diffuse, v_texCoord);\n        }"},e}(M);var j=0,B=0,C=new Uint8Array([255,255,255,255]);const U=function(){function t(t,e,r){void 0===e&&(e=1),void 0===r&&(r=1),this.m_IsLoaded=!1,this.m_Name=t,this.m_Width=e,this.m_Height=r,this.m_Handle=i.createTexture(),S.subscribe(O+this.m_Name,this),this.bind(),i.texImage2D(i.TEXTURE_2D,j,i.RGBA,1,1,B,i.RGBA,i.UNSIGNED_BYTE,C);var n=N.getAsset(this.m_Name);void 0!==n&&this.loadTextureFromAsset(n)}return t.prototype.destroy=function(){i.deleteTexture(this.m_Handle)},Object.defineProperty(t.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isLoaded",{get:function(){return this.m_IsLoaded},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this.m_Width},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.m_Height},enumerable:!1,configurable:!0}),t.prototype.bind=function(){i.bindTexture(i.TEXTURE_2D,this.m_Handle)},t.prototype.unbind=function(){i.bindTexture(i.TEXTURE_2D,void 0)},t.prototype.activateAndBind=function(t){void 0===t&&(t=0),i.activeTexture(i.TEXTURE0+t),this.bind()},t.prototype.onMessage=function(t){t.Code===O+this.m_Name&&(console.debug(this.m_Name+" loaded:",t.Context),this.loadTextureFromAsset(t.Context))},t.prototype.loadTextureFromAsset=function(t){this.m_Width=t.width,this.m_Height=t.height,this.bind(),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texImage2D(i.TEXTURE_2D,j,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t.Data),this.m_IsLoaded=!0},t}();var F=function(t){this.ReferenceNode=1,this.Texture=t};const G=function(){function t(){}return t.getTexture=function(e){if(void 0===t.m_Textures[e]){var r=new U(e);t.m_Textures[e]=new F(r)}else t.m_Textures[e].ReferenceNode++;return t.m_Textures[e].Texture},t.releaseTexture=function(e){t.m_Textures[e],void 0===t.m_Textures[e]?console.warn("A texture name ".concat(e," doesn't exist, hence can't be released")):(t.m_Textures[e].ReferenceNode--,t.m_Textures[e].ReferenceNode<1&&(t.m_Textures[e].Texture.destroy(),t.m_Textures[e]=void 0,delete t.m_Textures[e]))},t.m_Textures={},t}(),H=function(){function t(t,e,r){this.m_Name=t,this.m_DiffuseTextureName=e,this.m_Tint=r,void 0!==this.m_DiffuseTextureName&&(this.m_DiffuseTexture=G.getTexture(this.m_DiffuseTextureName))}return t.prototype.destroy=function(){G.releaseTexture(this.m_DiffuseTextureName),this.m_DiffuseTexture=void 0},Object.defineProperty(t.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseTexture",{get:function(){return this.m_DiffuseTexture},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tint",{get:function(){return this.m_Tint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseTexName",{get:function(){return this.m_DiffuseTextureName},set:function(t){void 0!==this.m_DiffuseTexture&&G.releaseTexture(this.m_DiffuseTextureName),this.m_DiffuseTextureName=t,void 0!==this.m_DiffuseTextureName&&G.getTexture(this.m_DiffuseTextureName)},enumerable:!1,configurable:!0}),t}(),z=function(){function t(t,e,r,n){void 0===t&&(t=255),void 0===e&&(e=255),void 0===r&&(r=255),void 0===n&&(n=255),this.m_R=t,this.m_G=e,this.m_B=r,this.m_A=n}return Object.defineProperty(t.prototype,"r",{get:function(){return this.m_R},set:function(t){this.m_R=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rFloat",{get:function(){return this.m_R/255},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this.m_G},set:function(t){this.m_G=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gFloat",{get:function(){return this.m_G/255},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this.m_B},set:function(t){this.m_B=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bFloat",{get:function(){return this.m_B/255},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this.m_A},set:function(t){this.m_A=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"aFloat",{get:function(){return this.m_A/255},enumerable:!1,configurable:!0}),t.prototype.toArray=function(){return[this.m_R,this.m_G,this.m_B,this.m_A]},t.prototype.toFloatArray=function(){return[this.m_R/255,this.m_G/255,this.m_B/255,this.m_A/255]},t.prototype.toFloat32Array=function(){return new Float32Array(this.toFloatArray())},t.white=function(){return new t(255,255,255,255)},t.black=function(){return new t(0,0,0,255)},t.red=function(){return new t(255,0,0,255)},t.green=function(){return new t(0,255,0,255)},t.blue=function(){return new t(0,0,255,255)},t}();var W=function(){function t(){var t;this.Position=r(),this.Rotation=0,this.Scale=(1,1,1,(t=r())[0]=1,t[1]=1,t[2]=1,t)}return t.prototype.copyFrom=function(t){n(this.Position,t.Position),this.Rotation=t.Rotation,n(this.Scale,t.Scale)},t.prototype.getTransformationMatrix=function(){var t,e,r,n,i,a,s,u,c,m,f,d,h,_,p,l,g,v,b=(t=o(),e=o(),l=(r=this.Position)[0],g=r[1],v=r[2],e===t?(t[12]=e[0]*l+e[4]*g+e[8]*v+e[12],t[13]=e[1]*l+e[5]*g+e[9]*v+e[13],t[14]=e[2]*l+e[6]*g+e[10]*v+e[14],t[15]=e[3]*l+e[7]*g+e[11]*v+e[15]):(n=e[0],i=e[1],a=e[2],s=e[3],u=e[4],c=e[5],m=e[6],f=e[7],d=e[8],h=e[9],_=e[10],p=e[11],t[0]=n,t[1]=i,t[2]=a,t[3]=s,t[4]=u,t[5]=c,t[6]=m,t[7]=f,t[8]=d,t[9]=h,t[10]=_,t[11]=p,t[12]=n*l+u*g+d*v+e[12],t[13]=i*l+c*g+h*v+e[13],t[14]=a*l+m*g+_*v+e[14],t[15]=s*l+f*g+p*v+e[15]),t);return function(t,e,r){var n=Math.sin(r),o=Math.cos(r),i=e[0],a=e[1],s=e[2],u=e[3],c=e[4],m=e[5],f=e[6],d=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=i*o+c*n,t[1]=a*o+m*n,t[2]=s*o+f*n,t[3]=u*o+d*n,t[4]=c*o-i*n,t[5]=m*o-a*n,t[6]=f*o-s*n,t[7]=d*o-u*n}(b,b,this.Rotation),function(t,e,r){var n=r[0],o=r[1],i=r[2];t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*o,t[5]=e[5]*o,t[6]=e[6]*o,t[7]=e[7]*o,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(b,b,this.Scale),b},t.prototype.setFromJson=function(t){void 0!==t.position&&(this.Position[0]=t.x,this.Position[1]=t.y,this.Position[2]=t.z),void 0!==t.rotation&&(this.Rotation=t.rotation),void 0!==t.scale&&(this.Scale[0]=t.x,this.Scale[1]=t.y,this.Scale[2]=t.z)},t}();const k=W;var V=function(){function t(t,e,r){this.m_Children=[],this.m_IsLoaded=!1,this.m_LocalMatrix=o(),this.m_WorldMatrix=o(),this.m_Components=[],this.Transform=new k,this.m_Id=t,this.Name=e,this.m_Scene=r}return Object.defineProperty(t.prototype,"id",{get:function(){return this.m_Id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this.m_Parent},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldMatrix",{get:function(){return this.m_WorldMatrix},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isLoaded",{get:function(){return this.m_IsLoaded},enumerable:!1,configurable:!0}),t.prototype.addChild=function(t){t.m_Parent=this,this.m_Children.push(t),t.onAdded(this.m_Scene)},t.prototype.removeChild=function(t){var e=this.m_Children.indexOf(t);-1!==e&&(t.m_Parent=void 0,this.m_Children.splice(e,1))},t.prototype.getObjectByName=function(t){if(this.Name===t)return this;for(var e=0,r=this.m_Children;e<r.length;e++){var n=r[e].getObjectByName(t);if(void 0!==n)return n}},t.prototype.addComponent=function(t){this.m_Components.push(t),t.setOwner(this)},t.prototype.load=function(){this.m_IsLoaded=!0;for(var t=0,e=this.m_Components;t<e.length;t++)e[t].load();for(var r=0,n=this.m_Children;r<n.length;r++)n[r].load()},t.prototype.update=function(t){this.m_LocalMatrix=this.Transform.getTransformationMatrix(),this.updateWorldMatrix(void 0!==this.m_Parent?this.m_Parent.worldMatrix:void 0);for(var e=0,r=this.m_Components;e<r.length;e++)r[e].update(t);for(var n=0,o=this.m_Children;n<o.length;n++)o[n].update(t)},t.prototype.render=function(t){for(var e=0,r=this.m_Components;e<r.length;e++)r[e].render(t);for(var n=0,o=this.m_Children;n<o.length;n++)o[n].render(t)},t.prototype.updateWorldMatrix=function(t){var e,r;void 0!==t?function(t,e,r){var n=e[0],o=e[1],i=e[2],a=e[3],s=e[4],u=e[5],c=e[6],m=e[7],f=e[8],d=e[9],h=e[10],_=e[11],p=e[12],l=e[13],g=e[14],v=e[15],b=r[0],y=r[1],T=r[2],A=r[3];t[0]=b*n+y*s+T*f+A*p,t[1]=b*o+y*u+T*d+A*l,t[2]=b*i+y*c+T*h+A*g,t[3]=b*a+y*m+T*_+A*v,b=r[4],y=r[5],T=r[6],A=r[7],t[4]=b*n+y*s+T*f+A*p,t[5]=b*o+y*u+T*d+A*l,t[6]=b*i+y*c+T*h+A*g,t[7]=b*a+y*m+T*_+A*v,b=r[8],y=r[9],T=r[10],A=r[11],t[8]=b*n+y*s+T*f+A*p,t[9]=b*o+y*u+T*d+A*l,t[10]=b*i+y*c+T*h+A*g,t[11]=b*a+y*m+T*_+A*v,b=r[12],y=r[13],T=r[14],A=r[15],t[12]=b*n+y*s+T*f+A*p,t[13]=b*o+y*u+T*d+A*l,t[14]=b*i+y*c+T*h+A*g,t[15]=b*a+y*m+T*_+A*v}(this.worldMatrix,t,this.m_LocalMatrix):(e=this.m_WorldMatrix,r=this.m_LocalMatrix,e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15])},t.prototype.onAdded=function(t){this.m_Scene=t},t}();const X=V;var J=function(){function t(){this.m_RootObj=new X(0,"__ROOT__",this)}return Object.defineProperty(t.prototype,"root",{get:function(){return this.m_RootObj},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isLoaded",{get:function(){return this.m_RootObj.isLoaded},enumerable:!1,configurable:!0}),t.prototype.addObject=function(t){this.m_RootObj.addChild(t)},t.prototype.getObjectByName=function(t){return this.m_RootObj.getObjectByName(t)},t.prototype.load=function(){this.m_RootObj.load()},t.prototype.update=function(t){this.m_RootObj.update(t)},t.prototype.render=function(t){this.m_RootObj.render(t)},t}();const Y=J;var Q;!function(t){t[t.UNINITILISED=0]="UNINITILISED",t[t.LOADING=1]="LOADING",t[t.UPDATING=2]="UPDATING"}(Q||(Q={}));var q=function(){function e(t,e,r){this.m_State=Q.UNINITILISED,this.m_GlobalId=-1,this.m_Id=t,this.m_Descritpion=r,this.m_Name=e,this.m_Scene=new Y}return Object.defineProperty(e.prototype,"id",{get:function(){return this.m_Id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){return this.m_Descritpion},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scene",{get:function(){return this.m_Scene},enumerable:!1,configurable:!0}),e.prototype.init=function(t){if(void 0===t.objects)throw new Error("Level init error: objects are missing");for(var e in t.objects){var r=t.objects[e];this.loadSimObject(r,this.m_Scene.root)}},e.prototype.load=function(){this.m_State=Q.LOADING,this.m_Scene.load(),this.m_State=Q.UPDATING},e.prototype.unload=function(){},e.prototype.update=function(t){this.m_State===Q.UPDATING&&this.m_Scene.update(t)},e.prototype.render=function(t){this.m_State===Q.UPDATING&&this.m_Scene.render(t)},e.prototype.onActivated=function(){},e.prototype.onDeactived=function(){},e.prototype.loadSimObject=function(e,r){var n;void 0!==e.name&&(n=String(e.name)),this.m_GlobalId++;var o=new X(this.m_GlobalId,n,this.m_Scene);if(void 0!==e.transform&&o.Transform.setFromJson(e.transform),void 0!==e.components)for(var i in e.components){var a=e.components[i],s=t.extractComponent(a);o.addComponent(s)}if(void 0!==e.children)for(var u in e.children){var c=e.children[u];this.loadSimObject(c,o)}void 0!==r&&r.addChild(o)},e}();const K=q;var Z=function(){function t(){}return t.init=function(){t.m_Instance=new t,t.m_RegisteredLevels[0]="../../assets/levels/testLevel.json"},t.changeLevel=function(e){if(void 0!==t.m_ActiveLevel&&(t.m_ActiveLevel.onDeactived(),t.m_ActiveLevel.unload(),t.m_ActiveLevel=void 0),void 0===t.m_RegisteredLevels[e])throw new Error("Level with id ".concat(e," doesn't exist."));if(N.isAssetLoaded(t.m_RegisteredLevels[e])){var r=N.getAsset(t.m_RegisteredLevels[e]);t.loadLevel(r)}else S.subscribe(O+t.m_RegisteredLevels[e],t.m_Instance),N.loadAsset(t.m_RegisteredLevels[e])},t.update=function(e){void 0!==t.m_ActiveLevel&&t.m_ActiveLevel.update(e)},t.render=function(e){void 0!==t.m_ActiveLevel&&t.m_ActiveLevel.render(e)},t.loadLevel=function(e){var r,n,o,i=e.Data;if(void 0===i.id)throw new Error("Level id missing");if(r=Number(i.id),void 0===i.name)throw new Error("Level name missing");n=String(i.name),void 0!==i.description&&(o=String(i.description)),t.m_ActiveLevel=new K(r,n,o),t.m_ActiveLevel.init(i),t.m_ActiveLevel.onActivated(),t.m_ActiveLevel.load()},t.prototype.onMessage=function(e){if(-1!==e.Code.indexOf(O)){var r=e.Context;console.log("Asset",r),t.loadLevel(r)}},t.m_GlobalLevelId=-1,t.m_RegisteredLevels={},t}();const $=Z,tt=function(){function t(){}return t.prototype.start=function(){this.m_Canvas=s.init(),N.init(),$.init(),i.clearColor(0,0,0,1),this.m_BasicShader=new I,this.m_BasicShader.use(),this.m_Projection=o(),this.m_Projection=a(this.m_Projection,0,this.m_Canvas.width,this.m_Canvas.height,0,-100,100),d.registerMaterial(new H("crate","../assets/textures/crate.jpg",new z(255,128,0,255))),$.changeLevel(0),this.resize(),this.loop()},t.prototype.resize=function(){void 0!==this.m_Canvas&&(this.m_Canvas.width=window.innerWidth,this.m_Canvas.height=window.innerHeight),i.viewport(0,0,this.m_Canvas.width,this.m_Canvas.height),this.m_Projection=a(this.m_Projection,0,this.m_Canvas.width,this.m_Canvas.height,0,-100,100)},t.prototype.loop=function(){A.update(0),$.update(0),i.clear(i.COLOR_BUFFER_BIT);var t=this.m_BasicShader.getUniformLocation("u_projection");i.uniformMatrix4fv(t,!1,new Float32Array(this.m_Projection)),$.render(this.m_BasicShader),requestAnimationFrame(this.loop.bind(this))},t}();var et;window.onload=function(){(et=new tt).start(),t.registerBuilder(new b)},window.onresize=function(){et.resize()}})();