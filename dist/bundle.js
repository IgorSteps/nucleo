(()=>{"use strict";var e,t=function(){function t(){}return t.init=function(t){var n;if(void 0!==t){if(void 0===(n=document.getElementById(t)))throw new Error("Cannot find a canvas element of id: "+t)}else n=document.createElement("canvas"),document.body.appendChild(n);if(void 0===(e=n.getContext("webgl2")))throw new Error("Unable to initilise WebGL2");return n},t}(),n="undefined"!=typeof Float32Array?Float32Array:Array;function r(){var e=new n(16);return n!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});const o=function(e,t){this.Message=e,this.Handler=t},i=function(){function e(){}return e.addSubscription=function(t,n){void 0===e.m_Subscriptions[t]&&(e.m_Subscriptions[t]=[]),-1!==e.m_Subscriptions[t].indexOf(n)?console.warn("Attempting to add duplicate handler to code ".concat(t,". Subscription not added")):e.m_Subscriptions[t].push(n)},e.removeSubscription=function(t,n){if(void 0!==e.m_Subscriptions[t]){var r=e.m_Subscriptions[t].indexOf(n);-1!==r&&e.m_Subscriptions[t].splice(r,1)}else console.warn("Can't unsubscribe thandelr from code ".concat(t,", because this code is not subscribed to."))},e.post=function(t){console.log("Message posted",t),void 0!==e.m_Subscriptions[t.Code]&&e.m_Subscriptions[t.Code].forEach((function(n){t.Priority===a.HIGH?n.onMessage(t):e.m_MessageQueue.push(new o(t,n))}))},e.update=function(t){if(0!=e.m_MessageQueue.length)for(var n=Math.min(e.m_QueueLimitPerFrame,e.m_MessageQueue.length),r=0;r<n;++r){var o=e.m_MessageQueue.pop();o.Handler.onMessage(o.Message)}},e.m_Subscriptions={},e.m_QueueLimitPerFrame=10,e.m_MessageQueue=[],e}();var a;!function(e){e[e.NORMAL=0]="NORMAL",e[e.HIGH=1]="HIGH"}(a||(a={}));const s=function(){function e(e,t,n,r){void 0===r&&(r=a.NORMAL),this.Code=e,this.Sender=t,this.Priority=r,this.Context=n}return e.send=function(t,n,r){i.post(new e(t,n,r))},e.sendPriority=function(t,n,r){i.post(new e(t,n,r,a.HIGH))},e.subscribe=function(e,t){i.addSubscription(e,t)},e.unsubscribe=function(e,t){i.removeSubscription(e,t)},e}();var u=function(){function e(e,t){this.Name=e,this.Data=t}return Object.defineProperty(e.prototype,"width",{get:function(){return this.Data.width},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.Data.height},enumerable:!1,configurable:!0}),e}();const c=function(){function e(){}return Object.defineProperty(e.prototype,"supportedExts",{get:function(){return["png","gif","jpg"]},enumerable:!1,configurable:!0}),e.prototype.loadAsset=function(e){var t=new Image;t.onload=this.onImageLoaded.bind(this,e,t),t.src=e},e.prototype.onImageLoaded=function(e,t){console.log("onImage loaded ".concat(e,"/").concat(t));var n=new u(e,t);d.onAssetLoaded(n)},e}();var m="MSG_ASSET_LOADER_ASSET_LOADED::";const d=function(){function e(){}return e.init=function(){e.m_Loaders.push(new c)},e.registerLoader=function(t){e.m_Loaders.push(t)},e.onAssetLoaded=function(t){e.m_LoadedAssets[t.Name]=t,s.send(m+t.Name,this,t)},e.loadAsset=function(t){for(var n=t.split(".").pop().toLowerCase(),r=0,o=e.m_Loaders;r<o.length;r++){var i=o[r];if(-1!==i.supportedExts.indexOf(n))return void i.loadAsset(t)}console.warn("Unable to load asset with extension ".concat(n,", because there is no loader associated with it."))},e.isAssetLoaded=function(t){return void 0!==e.m_LoadedAssets[t]},e.getAsset=function(t){var n=e.m_LoadedAssets[t];if(void 0!==n)return n;e.loadAsset(t)},e.m_Loaders=[],e.m_LoadedAssets={},e}();var f,h=function(){function t(e){this.m_Attributes={},this.m_Uniforms={},this.m_Name=e}return Object.defineProperty(t.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),t.prototype.load=function(t,n){var r=this.loadShader(t,e.VERTEX_SHADER),o=this.loadShader(n,e.FRAGMENT_SHADER);this.createShaderProgram(r,o),this.detectAttributes(),this.detectUniforms()},t.prototype.use=function(){e.useProgram(this.m_Program)},t.prototype.getAttributeLocation=function(e){if(void 0===this.m_Attributes[e])throw new Error("error getting attribute '".concat(e,"' :for ").concat(this.name));return this.m_Attributes[e]},t.prototype.getUniformLocation=function(e){if(void 0===this.m_Uniforms[e])throw new Error("error getting uniform '".concat(e,"' :for ").concat(this.name));return this.m_Uniforms[e]},t.prototype.loadShader=function(t,n){var r=e.createShader(n);if(e.shaderSource(r,t),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){var o=e.getShaderInfoLog(r);throw new Error("error compiling shader '".concat(this.m_Name,"' : ").concat(o))}return r},t.prototype.createShaderProgram=function(t,n){if(this.m_Program=e.createProgram(),e.attachShader(this.m_Program,t),e.attachShader(this.m_Program,n),e.linkProgram(this.m_Program),!e.getProgramParameter(this.m_Program,e.LINK_STATUS)){var r=e.getProgramInfoLog(this.m_Program);throw new Error("error linking shader ".concat(this.m_Name," : ").concat(r))}},t.prototype.detectAttributes=function(){for(var t=e.getProgramParameter(this.m_Program,e.ACTIVE_ATTRIBUTES),n=0;n<t;++n){var r=e.getActiveAttrib(this.m_Program,n);if(!r)break;this.m_Attributes[r.name]=e.getAttribLocation(this.m_Program,r.name)}},t.prototype.detectUniforms=function(){for(var t=e.getProgramParameter(this.m_Program,e.ACTIVE_UNIFORMS),n=0;n<t;++n){var r=e.getActiveUniform(this.m_Program,n);if(!r)break;this.m_Uniforms[r.name]=e.getUniformLocation(this.m_Program,r.name)}},t}(),_=(f=function(e,t){return f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},f(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}f(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});const p=function(e){function t(){var t=e.call(this,"basic")||this;return t.load(t.getVertexSource(),t.getFragmentSource()),t}return _(t,e),t.prototype.getVertexSource=function(){return"#version 300 es\n\n        in vec4 a_position;\n        in vec2 a_texCoord;\n\n        uniform mat4 u_projection;\n        uniform mat4 u_model;\n\n        out vec2 v_texCoord;\n        \n        void main() {\n            gl_Position =  u_projection * u_model * a_position;\n            v_texCoord = a_texCoord;\n        }"},t.prototype.getFragmentSource=function(){return"#version 300 es\n\n        precision highp float;\n\n        uniform vec4 u_tint;\n        uniform sampler2D u_diffuse;\n\n        out vec4 outColor;\n        in vec2 v_texCoord;\n        \n        \n        void main() {\n            outColor = u_tint * texture(u_diffuse, v_texCoord);\n        }"},t}(h);var l=function(e){this.m_ReferenceCount=1,this.m_Material=e},g=function(){function e(){}return e.registerMaterial=function(t){void 0===e.m_Materials[t.name]&&(e.m_Materials[t.name]=new l(t))},e.getMaterial=function(t){return void 0===e.m_Materials[t]?void 0:(e.m_Materials[t].m_ReferenceCount++,e.m_Materials[t].m_Material)},e.releaseMaterial=function(t){void 0===e.m_Materials[t]?console.warn("Can't release material that hasn't been registered"):(e.m_Materials[t].m_ReferenceCount--,e.m_Materials[t].m_ReferenceCount<1&&(e.m_Materials[t].m_Material.destroy(),e.m_Materials[t].m_Material=void 0,delete e.m_Materials[t]))},e.m_Materials={},e}();const b=g;var v=0,y=0,T=new Uint8Array([255,255,255,255]);const A=function(){function t(t,n,r){void 0===n&&(n=1),void 0===r&&(r=1),this.m_IsLoaded=!1,this.m_Name=t,this.m_Width=n,this.m_Height=r,this.m_Handle=e.createTexture(),s.subscribe(m+this.m_Name,this),this.bind(),e.texImage2D(e.TEXTURE_2D,v,e.RGBA,1,1,y,e.RGBA,e.UNSIGNED_BYTE,T);var o=d.getAsset(this.m_Name);void 0!==o&&this.loadTextureFromAsset(o)}return t.prototype.destroy=function(){e.deleteTexture(this.m_Handle)},Object.defineProperty(t.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isLoaded",{get:function(){return this.m_IsLoaded},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this.m_Width},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.m_Height},enumerable:!1,configurable:!0}),t.prototype.bind=function(){e.bindTexture(e.TEXTURE_2D,this.m_Handle)},t.prototype.unbind=function(){e.bindTexture(e.TEXTURE_2D,void 0)},t.prototype.activateAndBind=function(t){void 0===t&&(t=0),e.activeTexture(e.TEXTURE0+t),this.bind()},t.prototype.onMessage=function(e){e.Code===m+this.m_Name&&(console.debug(this.m_Name+" loaded:",e.Context),this.loadTextureFromAsset(e.Context))},t.prototype.loadTextureFromAsset=function(t){this.m_Width=t.width,this.m_Height=t.height,this.bind(),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,v,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.Data),this.m_IsLoaded=!0},t}();var P=function(e){this.ReferenceNode=1,this.Texture=e};const L=function(){function e(){}return e.getTexture=function(t){if(void 0===e.m_Textures[t]){var n=new A(t);e.m_Textures[t]=new P(n)}else e.m_Textures[t].ReferenceNode++;return e.m_Textures[t].Texture},e.releaseTexture=function(t){e.m_Textures[t],void 0===e.m_Textures[t]?console.warn("A texture name ".concat(t," doesn't exist, hence can't be released")):(e.m_Textures[t].ReferenceNode--,e.m_Textures[t].ReferenceNode<1&&(e.m_Textures[t].Texture.destroy(),e.m_Textures[t]=void 0,delete e.m_Textures[t]))},e.m_Textures={},e}(),x=function(){function e(e,t,n){this.m_Name=e,this.m_DiffuseTextureName=t,this.m_Tint=n,void 0!==this.m_DiffuseTextureName&&(this.m_DiffuseTexture=L.getTexture(this.m_DiffuseTextureName))}return e.prototype.destroy=function(){L.releaseTexture(this.m_DiffuseTextureName),this.m_DiffuseTexture=void 0},Object.defineProperty(e.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"diffuseTexture",{get:function(){return this.m_DiffuseTexture},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tint",{get:function(){return this.m_Tint},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"diffuseTexName",{get:function(){return this.m_DiffuseTextureName},set:function(e){void 0!==this.m_DiffuseTexture&&L.releaseTexture(this.m_DiffuseTextureName),this.m_DiffuseTextureName=e,void 0!==this.m_DiffuseTextureName&&L.getTexture(this.m_DiffuseTextureName)},enumerable:!1,configurable:!0}),e}(),S=function(){function e(e,t,n,r){void 0===e&&(e=255),void 0===t&&(t=255),void 0===n&&(n=255),void 0===r&&(r=255),this.m_R=e,this.m_G=t,this.m_B=n,this.m_A=r}return Object.defineProperty(e.prototype,"r",{get:function(){return this.m_R},set:function(e){this.m_R=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rFloat",{get:function(){return this.m_R/255},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"g",{get:function(){return this.m_G},set:function(e){this.m_G=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"gFloat",{get:function(){return this.m_G/255},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"b",{get:function(){return this.m_B},set:function(e){this.m_B=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bFloat",{get:function(){return this.m_B/255},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"a",{get:function(){return this.m_A},set:function(e){this.m_A=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"aFloat",{get:function(){return this.m_A/255},enumerable:!1,configurable:!0}),e.prototype.toArray=function(){return[this.m_R,this.m_G,this.m_B,this.m_A]},e.prototype.toFloatArray=function(){return[this.m_R/255,this.m_G/255,this.m_B/255,this.m_A/255]},e.prototype.toFloat32Array=function(){return new Float32Array(this.toFloatArray())},e.white=function(){return new e(255,255,255,255)},e.black=function(){return new e(0,0,0,255)},e.red=function(){return new e(255,0,0,255)},e.green=function(){return new e(0,255,0,255)},e.blue=function(){return new e(0,0,255,255)},e}();function w(){var e=new n(3);return n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function E(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}w();var O=function(){function e(){var e;this.Position=w(),this.Rotation=0,this.Scale=(1,1,1,(e=w())[0]=1,e[1]=1,e[2]=1,e)}return e.prototype.copyFrom=function(e){E(this.Position,e.Position),this.Rotation=e.Rotation,E(this.Scale,e.Scale)},e.prototype.getTransformationMatrix=function(){var e,t,n,o,i,a,s,u,c,m,d,f,h,_,p,l,g,b,v=(e=r(),t=r(),l=(n=this.Position)[0],g=n[1],b=n[2],t===e?(e[12]=t[0]*l+t[4]*g+t[8]*b+t[12],e[13]=t[1]*l+t[5]*g+t[9]*b+t[13],e[14]=t[2]*l+t[6]*g+t[10]*b+t[14],e[15]=t[3]*l+t[7]*g+t[11]*b+t[15]):(o=t[0],i=t[1],a=t[2],s=t[3],u=t[4],c=t[5],m=t[6],d=t[7],f=t[8],h=t[9],_=t[10],p=t[11],e[0]=o,e[1]=i,e[2]=a,e[3]=s,e[4]=u,e[5]=c,e[6]=m,e[7]=d,e[8]=f,e[9]=h,e[10]=_,e[11]=p,e[12]=o*l+u*g+f*b+t[12],e[13]=i*l+c*g+h*b+t[13],e[14]=a*l+m*g+_*b+t[14],e[15]=s*l+d*g+p*b+t[15]),e);return function(e,t,n){var r=Math.sin(n),o=Math.cos(n),i=t[0],a=t[1],s=t[2],u=t[3],c=t[4],m=t[5],d=t[6],f=t[7];t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=i*o+c*r,e[1]=a*o+m*r,e[2]=s*o+d*r,e[3]=u*o+f*r,e[4]=c*o-i*r,e[5]=m*o-a*r,e[6]=d*o-s*r,e[7]=f*o-u*r}(v,v,this.Rotation),function(e,t,n){var r=n[0],o=n[1],i=n[2];e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*o,e[5]=t[5]*o,e[6]=t[6]*o,e[7]=t[7]*o,e[8]=t[8]*i,e[9]=t[9]*i,e[10]=t[10]*i,e[11]=t[11]*i,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]}(v,v,this.Scale),v},e}();const I=O;var N=function(){function e(e,t,n){this.m_Children=[],this.m_IsLoaded=!1,this.m_LocalMatrix=r(),this.m_WorldMatrix=r(),this.Transform=new I,this.m_Id=e,this.Name=t,this.m_Scene=n}return Object.defineProperty(e.prototype,"id",{get:function(){return this.m_Id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return this.m_Parent},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"worldMatrix",{get:function(){return this.m_WorldMatrix},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isLoaded",{get:function(){return this.m_IsLoaded},enumerable:!1,configurable:!0}),e.prototype.addChild=function(e){e.m_Parent=this,this.m_Children.push(e),e.onAdded(this.m_Scene)},e.prototype.removeChild=function(e){var t=this.m_Children.indexOf(e);-1!==t&&(e.m_Parent=void 0,this.m_Children.splice(t,1))},e.prototype.getObjectByName=function(e){if(this.Name===e)return this;for(var t=0,n=this.m_Children;t<n.length;t++){var r=n[t].getObjectByName(e);if(void 0!==r)return r}},e.prototype.load=function(){this.m_IsLoaded=!0;for(var e=0,t=this.m_Children;e<t.length;e++)t[e].load()},e.prototype.update=function(e){for(var t=0,n=this.m_Children;t<n.length;t++)n[t].update(e)},e.prototype.render=function(e){for(var t=0,n=this.m_Children;t<n.length;t++)n[t].render(e)},e.prototype.onAdded=function(e){this.m_Scene=e},e}();const R=N;const M=function(){function e(){this.m_RootObj=new R(0,"__ROOT__",this)}return Object.defineProperty(e.prototype,"root",{get:function(){return this.m_RootObj},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isLoaded",{get:function(){return this.m_RootObj.isLoaded},enumerable:!1,configurable:!0}),e.prototype.addObject=function(e){this.m_RootObj.addChild(e)},e.prototype.getObjectByName=function(e){return this.m_RootObj.getObjectByName(e)},e.prototype.load=function(){this.m_RootObj.load()},e.prototype.update=function(e){this.m_RootObj.update(e)},e.prototype.render=function(e){this.m_RootObj.render(e)},e}();var j;!function(e){e[e.UNINITILISED=0]="UNINITILISED",e[e.LOADING=1]="LOADING",e[e.UPDATING=2]="UPDATING"}(j||(j={}));const C=function(){function e(e,t,n){this.m_State=j.UNINITILISED,this.m_Id=e,this.m_Descritpion=n,this.m_Name=t,this.m_Scene=new M}return Object.defineProperty(e.prototype,"id",{get:function(){return this.m_Id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){return this.m_Descritpion},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scene",{get:function(){return this.m_Scene},enumerable:!1,configurable:!0}),e.prototype.load=function(){this.m_State=j.LOADING,this.m_Scene.load(),this.m_State=j.UPDATING},e.prototype.unload=function(){},e.prototype.update=function(e){this.m_State===j.UPDATING&&this.m_Scene.update(e)},e.prototype.render=function(e){this.m_State===j.UPDATING&&(console.log("drawing"),this.m_Scene.render(e))},e.prototype.onActivated=function(){},e.prototype.onDeactived=function(){},e}();const D=function(){function e(){}return e.createLevel=function(t,n){e.m_GlobalLevelId++;var r=new C(e.m_GlobalLevelId,t,n);return e.m_Levels[e.m_GlobalLevelId]=r,e.m_GlobalLevelId},e.createTestLvl=function(){e.m_GlobalLevelId++;var t=new C(e.m_GlobalLevelId,"test","simple test");return e.m_Levels[e.m_GlobalLevelId]=t,e.m_GlobalLevelId},e.changeLevel=function(t){void 0!==e.m_ActiveLevel&&(e.m_ActiveLevel.onDeactived(),e.m_ActiveLevel.unload()),void 0!==e.m_Levels[t]&&(e.m_ActiveLevel=e.m_Levels[t],e.m_ActiveLevel.onActivated())},e.update=function(t){void 0!==e.m_ActiveLevel&&e.m_ActiveLevel.update(t)},e.render=function(t){void 0!==e.m_ActiveLevel&&e.m_ActiveLevel.render(t)},e.m_GlobalLevelId=-1,e.m_Levels={},e}(),U=function(){function n(){}return n.prototype.start=function(){var n,o,i,a,s,u,c,m,f,h;this.m_Canvas=t.init(),d.init(),e.clearColor(0,0,0,1),this.m_BasicShader=new p,this.m_BasicShader.use(),this.m_Projection=r(),this.m_Projection=(n=this.m_Projection,o=0,i=this.m_Canvas.width,a=this.m_Canvas.height,m=1/(o-i),f=1/(a-(s=0)),h=1/((u=-100)-(c=100)),n[0]=-2*m,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*f,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*h,n[11]=0,n[12]=(o+i)*m,n[13]=(s+a)*f,n[14]=(c+u)*h,n[15]=1,n),b.registerMaterial(new x("crate","../assets/textures/crate.jpg",new S(255,128,0,255)));var _=D.createTestLvl();D.changeLevel(_),this.resize(),this.loop()},n.prototype.resize=function(){void 0!==this.m_Canvas&&(this.m_Canvas.width=window.innerWidth,this.m_Canvas.height=window.innerHeight),e.viewport(0,0,this.m_Canvas.width,this.m_Canvas.height)},n.prototype.loop=function(){i.update(0),D.update(0),e.clear(e.COLOR_BUFFER_BIT);var t=this.m_BasicShader.getUniformLocation("u_projection");e.uniformMatrix4fv(t,!1,new Float32Array(this.m_Projection)),D.render(this.m_BasicShader),requestAnimationFrame(this.loop.bind(this))},n}();var G;window.onload=function(){(G=new U).start()},window.onresize=function(){G.resize()}})();