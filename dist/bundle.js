(()=>{"use strict";var t,e=function(){function e(){}return e.init=function(e){var r;if(void 0!==e){if(void 0===(r=document.getElementById(e)))throw new Error("Cannot find a canvas element of id: "+e)}else r=document.createElement("canvas"),document.body.appendChild(r);if(void 0===(t=r.getContext("webgl2")))throw new Error("Unable to initilise WebGL2");return r},e}(),r="undefined"!=typeof Float32Array?Float32Array:Array;function n(){var t=new r(16);return r!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var o=function(t,e,r,n,o,i,a){var s=1/(e-r),u=1/(n-o),c=1/(i-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+r)*s,t[13]=(o+n)*u,t[14]=(a+i)*c,t[15]=1,t};const i=function(t,e){this.Message=t,this.Handler=e},a=function(){function t(){}return t.addSubscription=function(e,r){void 0===t.m_Subscriptions[e]&&(t.m_Subscriptions[e]=[]),-1!==t.m_Subscriptions[e].indexOf(r)?console.warn("Attempting to add duplicate handler to code ".concat(e,". Subscription not added")):t.m_Subscriptions[e].push(r)},t.removeSubscription=function(e,r){if(void 0!==t.m_Subscriptions[e]){var n=t.m_Subscriptions[e].indexOf(r);-1!==n&&t.m_Subscriptions[e].splice(n,1)}else console.warn("Can't unsubscribe thandelr from code ".concat(e,", because this code is not subscribed to."))},t.post=function(e){console.log("Message posted",e),void 0!==t.m_Subscriptions[e.Code]&&t.m_Subscriptions[e.Code].forEach((function(r){e.Priority===s.HIGH?r.onMessage(e):t.m_MessageQueue.push(new i(e,r))}))},t.update=function(e){if(0!=t.m_MessageQueue.length)for(var r=Math.min(t.m_QueueLimitPerFrame,t.m_MessageQueue.length),n=0;n<r;++n){var o=t.m_MessageQueue.pop();o.Handler.onMessage(o.Message)}},t.m_Subscriptions={},t.m_QueueLimitPerFrame=10,t.m_MessageQueue=[],t}();var s;!function(t){t[t.NORMAL=0]="NORMAL",t[t.HIGH=1]="HIGH"}(s||(s={}));const u=function(){function t(t,e,r,n){void 0===n&&(n=s.NORMAL),this.Code=t,this.Sender=e,this.Priority=n,this.Context=r}return t.send=function(e,r,n){a.post(new t(e,r,n))},t.sendPriority=function(e,r,n){a.post(new t(e,r,n,s.HIGH))},t.subscribe=function(t,e){a.addSubscription(t,e)},t.unsubscribe=function(t,e){a.removeSubscription(t,e)},t}();var c=function(){function t(t,e){this.Name=t,this.Data=e}return Object.defineProperty(t.prototype,"width",{get:function(){return this.Data.width},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.Data.height},enumerable:!1,configurable:!0}),t}();const m=function(){function t(){}return Object.defineProperty(t.prototype,"supportedExts",{get:function(){return["png","gif","jpg"]},enumerable:!1,configurable:!0}),t.prototype.loadAsset=function(t){var e=new Image;e.onload=this.onImageLoaded.bind(this,t,e),e.src=t},t.prototype.onImageLoaded=function(t,e){console.log("onImage loaded ".concat(t,"/").concat(e));var r=new c(t,e);p.onAssetLoaded(r)},t}();var f=function(t,e){this.Name=t,this.Data=e};const d=function(){function t(){}return Object.defineProperty(t.prototype,"supportedExts",{get:function(){return["json"]},enumerable:!1,configurable:!0}),t.prototype.loadAsset=function(t){var e=new XMLHttpRequest;e.open("GET",t),e.addEventListener("load",this.onJsonLoaded.bind(this,t,e)),e.send()},t.prototype.onJsonLoaded=function(t,e){if(console.log("onJsonLoaded loaded",t,e),e.readyState===e.DONE){var r=JSON.parse(e.responseText),n=new f(t,r);p.onAssetLoaded(n)}},t}();var h="MSG_ASSET_LOADER_ASSET_LOADED::";const p=function(){function t(){}return t.init=function(){t.m_Loaders.push(new m),t.m_Loaders.push(new d)},t.registerLoader=function(e){t.m_Loaders.push(e)},t.onAssetLoaded=function(e){t.m_LoadedAssets[e.Name]=e,u.send(h+e.Name,this,e)},t.loadAsset=function(e){for(var r=e.split(".").pop().toLowerCase(),n=0,o=t.m_Loaders;n<o.length;n++){var i=o[n];if(-1!==i.supportedExts.indexOf(r))return void i.loadAsset(e)}console.warn("Unable to load asset with extension ".concat(r,", because there is no loader associated with it."))},t.isAssetLoaded=function(e){return void 0!==t.m_LoadedAssets[e]},t.getAsset=function(e){var r=t.m_LoadedAssets[e];if(void 0!==r)return r;t.loadAsset(e)},t.m_Loaders=[],t.m_LoadedAssets={},t}();var _,l=function(){function e(t){this.m_Attributes={},this.m_Uniforms={},this.m_Name=t}return Object.defineProperty(e.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),e.prototype.load=function(e,r){var n=this.loadShader(e,t.VERTEX_SHADER),o=this.loadShader(r,t.FRAGMENT_SHADER);this.createShaderProgram(n,o),this.detectAttributes(),this.detectUniforms()},e.prototype.use=function(){t.useProgram(this.m_Program)},e.prototype.getAttributeLocation=function(t){if(void 0===this.m_Attributes[t])throw new Error("error getting attribute '".concat(t,"' :for ").concat(this.name));return this.m_Attributes[t]},e.prototype.getUniformLocation=function(t){if(void 0===this.m_Uniforms[t])throw new Error("error getting uniform '".concat(t,"' :for ").concat(this.name));return this.m_Uniforms[t]},e.prototype.loadShader=function(e,r){var n=t.createShader(r);if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){var o=t.getShaderInfoLog(n);throw new Error("error compiling shader '".concat(this.m_Name,"' : ").concat(o))}return n},e.prototype.createShaderProgram=function(e,r){if(this.m_Program=t.createProgram(),t.attachShader(this.m_Program,e),t.attachShader(this.m_Program,r),t.linkProgram(this.m_Program),!t.getProgramParameter(this.m_Program,t.LINK_STATUS)){var n=t.getProgramInfoLog(this.m_Program);throw new Error("error linking shader ".concat(this.m_Name," : ").concat(n))}},e.prototype.detectAttributes=function(){for(var e=t.getProgramParameter(this.m_Program,t.ACTIVE_ATTRIBUTES),r=0;r<e;++r){var n=t.getActiveAttrib(this.m_Program,r);if(!n)break;this.m_Attributes[n.name]=t.getAttribLocation(this.m_Program,n.name)}},e.prototype.detectUniforms=function(){for(var e=t.getProgramParameter(this.m_Program,t.ACTIVE_UNIFORMS),r=0;r<e;++r){var n=t.getActiveUniform(this.m_Program,r);if(!n)break;this.m_Uniforms[n.name]=t.getUniformLocation(this.m_Program,n.name)}},e}(),v=(_=function(t,e){return _=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},_(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}_(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});const y=function(t){function e(){var e=t.call(this,"basic")||this;return e.load(e.getVertexSource(),e.getFragmentSource()),e}return v(e,t),e.prototype.getVertexSource=function(){return"#version 300 es\n\n        in vec4 a_position;\n        in vec2 a_texCoord;\n\n        uniform mat4 u_projection;\n        uniform mat4 u_model;\n\n        out vec2 v_texCoord;\n        \n        void main() {\n            gl_Position =  u_projection * u_model * a_position;\n            v_texCoord = a_texCoord;\n        }"},e.prototype.getFragmentSource=function(){return"#version 300 es\n\n        precision highp float;\n\n        uniform vec4 u_tint;\n        uniform sampler2D u_diffuse;\n\n        out vec4 outColor;\n        in vec2 v_texCoord;\n        \n        \n        void main() {\n            outColor = u_tint * texture(u_diffuse, v_texCoord);\n        }"},e}(l);var g=function(t){this.m_ReferenceCount=1,this.m_Material=t},b=function(){function t(){}return t.registerMaterial=function(e){void 0===t.m_Materials[e.name]&&(t.m_Materials[e.name]=new g(e))},t.getMaterial=function(e){return void 0===t.m_Materials[e]?void 0:(t.m_Materials[e].m_ReferenceCount++,t.m_Materials[e].m_Material)},t.releaseMaterial=function(e){void 0===t.m_Materials[e]?console.warn("Can't release material that hasn't been registered"):(t.m_Materials[e].m_ReferenceCount--,t.m_Materials[e].m_ReferenceCount<1&&(t.m_Materials[e].m_Material.destroy(),t.m_Materials[e].m_Material=void 0,delete t.m_Materials[e]))},t.m_Materials={},t}();const T=b;var A=0,w=0,S=new Uint8Array([255,255,255,255]);const L=function(){function e(e,r,n){void 0===r&&(r=1),void 0===n&&(n=1),this.m_IsLoaded=!1,this.m_Name=e,this.m_Width=r,this.m_Height=n,this.m_Handle=t.createTexture(),u.subscribe(h+this.m_Name,this),this.bind(),t.texImage2D(t.TEXTURE_2D,A,t.RGBA,1,1,w,t.RGBA,t.UNSIGNED_BYTE,S);var o=p.getAsset(this.m_Name);void 0!==o&&this.loadTextureFromAsset(o)}return e.prototype.destroy=function(){t.deleteTexture(this.m_Handle)},Object.defineProperty(e.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isLoaded",{get:function(){return this.m_IsLoaded},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this.m_Width},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.m_Height},enumerable:!1,configurable:!0}),e.prototype.bind=function(){t.bindTexture(t.TEXTURE_2D,this.m_Handle)},e.prototype.unbind=function(){t.bindTexture(t.TEXTURE_2D,void 0)},e.prototype.activateAndBind=function(e){void 0===e&&(e=0),t.activeTexture(t.TEXTURE0+e),this.bind()},e.prototype.onMessage=function(t){t.Code===h+this.m_Name&&(console.debug(this.m_Name+" loaded:",t.Context),this.loadTextureFromAsset(t.Context))},e.prototype.loadTextureFromAsset=function(e){this.m_Width=e.width,this.m_Height=e.height,this.bind(),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,A,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e.Data),this.m_IsLoaded=!0},e}();var x=function(t){this.ReferenceNode=1,this.Texture=t};const O=function(){function t(){}return t.getTexture=function(e){if(void 0===t.m_Textures[e]){var r=new L(e);t.m_Textures[e]=new x(r)}else t.m_Textures[e].ReferenceNode++;return t.m_Textures[e].Texture},t.releaseTexture=function(e){t.m_Textures[e],void 0===t.m_Textures[e]?console.warn("A texture name ".concat(e," doesn't exist, hence can't be released")):(t.m_Textures[e].ReferenceNode--,t.m_Textures[e].ReferenceNode<1&&(t.m_Textures[e].Texture.destroy(),t.m_Textures[e]=void 0,delete t.m_Textures[e]))},t.m_Textures={},t}(),E=function(){function t(t,e,r){this.m_Name=t,this.m_DiffuseTextureName=e,this.m_Tint=r,void 0!==this.m_DiffuseTextureName&&(this.m_DiffuseTexture=O.getTexture(this.m_DiffuseTextureName))}return t.prototype.destroy=function(){O.releaseTexture(this.m_DiffuseTextureName),this.m_DiffuseTexture=void 0},Object.defineProperty(t.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseTexture",{get:function(){return this.m_DiffuseTexture},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tint",{get:function(){return this.m_Tint},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"diffuseTexName",{get:function(){return this.m_DiffuseTextureName},set:function(t){void 0!==this.m_DiffuseTexture&&O.releaseTexture(this.m_DiffuseTextureName),this.m_DiffuseTextureName=t,void 0!==this.m_DiffuseTextureName&&O.getTexture(this.m_DiffuseTextureName)},enumerable:!1,configurable:!0}),t}(),P=function(){function t(t,e,r,n){void 0===t&&(t=255),void 0===e&&(e=255),void 0===r&&(r=255),void 0===n&&(n=255),this.m_R=t,this.m_G=e,this.m_B=r,this.m_A=n}return Object.defineProperty(t.prototype,"r",{get:function(){return this.m_R},set:function(t){this.m_R=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rFloat",{get:function(){return this.m_R/255},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this.m_G},set:function(t){this.m_G=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gFloat",{get:function(){return this.m_G/255},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this.m_B},set:function(t){this.m_B=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bFloat",{get:function(){return this.m_B/255},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"a",{get:function(){return this.m_A},set:function(t){this.m_A=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"aFloat",{get:function(){return this.m_A/255},enumerable:!1,configurable:!0}),t.prototype.toArray=function(){return[this.m_R,this.m_G,this.m_B,this.m_A]},t.prototype.toFloatArray=function(){return[this.m_R/255,this.m_G/255,this.m_B/255,this.m_A/255]},t.prototype.toFloat32Array=function(){return new Float32Array(this.toFloatArray())},t.white=function(){return new t(255,255,255,255)},t.black=function(){return new t(0,0,0,255)},t.red=function(){return new t(255,0,0,255)},t.green=function(){return new t(0,255,0,255)},t.blue=function(){return new t(0,0,255,255)},t}();var R=function(){function t(t){this.m_Data=t,this.name=this.m_Data.name}return t.prototype.setOwner=function(t){this.m_Owner=t},t.prototype.update=function(t){},t.prototype.apply=function(t){},t}(),N=function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),M=function(){function t(){this.rotation=0}return t.prototype.setFromJson=function(t){if(void 0===t.name)throw new Error("Behaviour data is missing a name.");this.name=String(t.name),void 0!==t.rotation&&(this.rotation=Number(t.rotation))},t}(),D=function(){function t(){}return Object.defineProperty(t.prototype,"type",{get:function(){return"rotation"},enumerable:!1,configurable:!0}),t.prototype.buildFromJson=function(t){var e=new M;return e.setFromJson(t),new B(e)},t}(),B=function(t){function e(e){var r=t.call(this,e)||this;return r.m_Rotation=e.rotation,r}return N(e,t),e.prototype.update=function(e){this.m_Owner.Transform.Rotation+=this.m_Rotation,t.prototype.update.call(this,e)},e}(R),j=function(){function t(){}return t.init=function(){t.registerBuilder(new D)},t.registerBuilder=function(e){t.m_RegisteredBuilders[e.type]=e},t.extractBehaviour=function(e){if(void 0!==e.type){if(void 0!==t.m_RegisteredBuilders[String(e.type)])return t.m_RegisteredBuilders[String(e.type)].buildFromJson(e);throw new Error("Behaviour manager is missing type or builder is not registered for this type")}},t.m_RegisteredBuilders={},t}();function I(){var t=new r(3);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function C(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function U(t,e,r,n){return t[0]=e,t[1]=r,t[2]=n,t}I();var F=function(){},G=function(){function e(e,r,n,o){switch(void 0===r&&(r=t.FLOAT),void 0===n&&(n=t.ARRAY_BUFFER),void 0===o&&(o=t.TRIANGLES),this.m_HasAttributeLocation=!1,this.m_Data=[],this.m_Attributes=[],this.m_ElementSize=e,this.m_DataType=r,this.m_TargetBufferType=n,this.m_Mode=o,this.m_DataType){case t.FLOAT:case t.INT:case t.UNSIGNED_INT:this.m_TypeSize=4;break;case t.SHORT:case t.UNSIGNED_SHORT:this.m_TypeSize=2;break;case t.BYTE:case t.UNSIGNED_BYTE:this.m_TypeSize=1;break;default:throw new Error("Unrecognised data type ".concat(r.toString()))}this.m_Stride=this.m_ElementSize*this.m_TypeSize,this.m_GLBuffer=t.createBuffer(),this.m_VAO=t.createVertexArray()}return e.prototype.destroy=function(){t.deleteBuffer(this.m_GLBuffer)},e.prototype.bind=function(e){var r=this;void 0===e&&(e=!1),t.bindVertexArray(this.m_VAO),t.bindBuffer(this.m_TargetBufferType,this.m_GLBuffer),this.m_HasAttributeLocation&&this.m_Attributes.forEach((function(n){t.vertexAttribPointer(n.location,n.size,r.m_DataType,e,r.m_Stride,n.offset*r.m_TypeSize),t.enableVertexAttribArray(n.location)}))},e.prototype.bindVAO=function(){t.bindVertexArray(this.m_VAO)},e.prototype.unbind=function(){t.bindBuffer(t.ARRAY_BUFFER,void 0),t.bindVertexArray(null)},e.prototype.addAttributeLocation=function(t){this.m_HasAttributeLocation=!0,this.m_Attributes.push(t)},e.prototype.pushBackData=function(t){var e=this;t.forEach((function(t){e.m_Data.push(t)}))},e.prototype.upload=function(){var e;switch(t.bindBuffer(this.m_TargetBufferType,this.m_GLBuffer),this.m_DataType){case t.FLOAT:e=new Float32Array(this.m_Data);break;case t.INT:e=new Int32Array(this.m_Data);break;case t.UNSIGNED_INT:e=new Uint32Array(this.m_Data);break;case t.SHORT:e=new Int16Array(this.m_Data);break;case t.UNSIGNED_SHORT:e=new Uint16Array(this.m_Data);break;case t.BYTE:e=new Int8Array(this.m_Data);break;case t.UNSIGNED_BYTE:e=new Uint8Array(this.m_Data)}t.bufferData(this.m_TargetBufferType,e,t.STATIC_DRAW)},e.prototype.draw=function(){this.m_TargetBufferType===t.ARRAY_BUFFER?t.drawArrays(this.m_Mode,0,this.m_Data.length/this.m_ElementSize):this.m_TargetBufferType===t.ELEMENT_ARRAY_BUFFER&&t.drawElements(this.m_Mode,this.m_Data.length,this.m_DataType,0)},e}();const H=function(){function e(t,e,r,o){void 0===r&&(r=100),void 0===o&&(o=100),this.m_Position=I(),this.m_Name=t,this.m_Height=o,this.m_Width=r,this.m_MaterialName=e,this.m_Material=T.getMaterial(this.m_MaterialName),this.m_Model=n()}return e.prototype.destroy=function(){this.m_Buffer.destroy(),T.releaseMaterial(this.m_MaterialName),this.m_Material=void 0,this.m_MaterialName=void 0},Object.defineProperty(e.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),e.prototype.load=function(){this.m_Buffer=new G(5);var t=new F;t.location=0,t.size=3,t.offset=0,this.m_Buffer.addAttributeLocation(t);var e=new F;e.location=1,e.size=2,e.offset=3,this.m_Buffer.addAttributeLocation(e),this.m_Buffer.bind();var r=[0,0,0,0,0,0,this.m_Height,0,0,1,this.m_Width,this.m_Height,0,1,1,this.m_Width,this.m_Height,0,1,1,this.m_Width,0,0,1,0,0,0,0,0,0];this.m_Buffer.pushBackData(r),this.m_Buffer.upload(),this.m_Buffer.unbind()},e.prototype.update=function(t){},e.prototype.draw=function(e,r){var n=e.getUniformLocation("u_model");t.uniformMatrix4fv(n,!1,r);var o=e.getUniformLocation("u_tint");if(t.uniform4fv(o,this.m_Material.tint.toFloat32Array()),void 0!==this.m_Material.diffuseTexture){this.m_Material.diffuseTexture.activateAndBind(0);var i=e.getUniformLocation("u_diffuse");t.uniform1i(i,0)}this.m_Buffer.bindVAO(),this.m_Buffer.draw()},e}(),z=function(){function t(t){this.m_Data=t,this.name=t.name}return Object.defineProperty(t.prototype,"owner",{get:function(){return this.m_Owner},enumerable:!1,configurable:!0}),t.prototype.setOwner=function(t){this.m_Owner=t},t.prototype.load=function(){},t.prototype.update=function(t){},t.prototype.render=function(t){},t}();var W=function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),k=function(){function t(){}return t.prototype.setFromJson=function(t){void 0!==t.name&&(this.name=String(t.name)),void 0!==t.name&&(this.materialName=String(t.materialName))},t}(),V=function(){function t(){}return Object.defineProperty(t.prototype,"type",{get:function(){return"sprite"},enumerable:!1,configurable:!0}),t.prototype.buildFromJson=function(t){var e=new k;return e.setFromJson(t),new X(e)},t}(),X=function(t){function e(e){var r=t.call(this,e)||this;return r.m_Sprite=new H(r.name,e.materialName),r}return W(e,t),e.prototype.load=function(){this.m_Sprite.load()},e.prototype.render=function(e){this.m_Sprite.draw(e,this.m_Owner.worldMatrix),t.prototype.render.call(this,e)},e}(z),J=function(){function t(){}return t.init=function(){t.registerBuilder(new V)},t.registerBuilder=function(e){t.m_RegisteredBuilders[e.type]=e},t.extractComponent=function(e){if(void 0!==e.type){if(void 0!==t.m_RegisteredBuilders[String(e.type)])return t.m_RegisteredBuilders[String(e.type)].buildFromJson(e);throw new Error("Component manager is missing type or builder is not registered for this type")}},t.m_RegisteredBuilders={},t}(),Y=function(){function t(){this.Position=I(),this.Rotation=0,this.Scale=U(I(),1,1,1)}return t.prototype.copyFrom=function(t){C(this.Position,t.Position),this.Rotation=t.Rotation,C(this.Scale,t.Scale)},t.prototype.getTransformationMatrix=function(){var t,e,r,o,i,a,s,u,c,m,f,d,h,p,_,l,v,y,g=(t=n(),e=n(),l=(r=this.Position)[0],v=r[1],y=r[2],e===t?(t[12]=e[0]*l+e[4]*v+e[8]*y+e[12],t[13]=e[1]*l+e[5]*v+e[9]*y+e[13],t[14]=e[2]*l+e[6]*v+e[10]*y+e[14],t[15]=e[3]*l+e[7]*v+e[11]*y+e[15]):(o=e[0],i=e[1],a=e[2],s=e[3],u=e[4],c=e[5],m=e[6],f=e[7],d=e[8],h=e[9],p=e[10],_=e[11],t[0]=o,t[1]=i,t[2]=a,t[3]=s,t[4]=u,t[5]=c,t[6]=m,t[7]=f,t[8]=d,t[9]=h,t[10]=p,t[11]=_,t[12]=o*l+u*v+d*y+e[12],t[13]=i*l+c*v+h*y+e[13],t[14]=a*l+m*v+p*y+e[14],t[15]=s*l+f*v+_*y+e[15]),t);return function(t,e,r){var n=Math.sin(r),o=Math.cos(r),i=e[0],a=e[1],s=e[2],u=e[3],c=e[4],m=e[5],f=e[6],d=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=i*o+c*n,t[1]=a*o+m*n,t[2]=s*o+f*n,t[3]=u*o+d*n,t[4]=c*o-i*n,t[5]=m*o-a*n,t[6]=f*o-s*n,t[7]=d*o-u*n}(g,g,this.Rotation),function(t,e,r){var n=r[0],o=r[1],i=r[2];t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*o,t[5]=e[5]*o,t[6]=e[6]*o,t[7]=e[7]*o,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(g,g,this.Scale),g},t.prototype.setFromJson=function(t){void 0!==t.position&&U(this.Position,t.position.x,t.position.y,t.position.z),void 0!==t.rotation&&(this.Rotation=t.rotation),void 0!==t.scale&&(this.Scale[0]=t.position.x,this.Scale[1]=t.position.y,this.Scale[2]=t.position.z)},t}();const Q=Y;var q=function(){function t(t,e,r){this.m_Children=[],this.m_IsLoaded=!1,this.m_LocalMatrix=n(),this.m_WorldMatrix=n(),this.m_Components=[],this.m_Behaviours=[],this.Transform=new Q,this.m_Id=t,this.Name=e,this.m_Scene=r}return Object.defineProperty(t.prototype,"id",{get:function(){return this.m_Id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this.m_Parent},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"worldMatrix",{get:function(){return this.m_WorldMatrix},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isLoaded",{get:function(){return this.m_IsLoaded},enumerable:!1,configurable:!0}),t.prototype.addChild=function(t){t.m_Parent=this,this.m_Children.push(t),t.onAdded(this.m_Scene)},t.prototype.removeChild=function(t){var e=this.m_Children.indexOf(t);-1!==e&&(t.m_Parent=void 0,this.m_Children.splice(e,1))},t.prototype.getObjectByName=function(t){if(this.Name===t)return this;for(var e=0,r=this.m_Children;e<r.length;e++){var n=r[e].getObjectByName(t);if(void 0!==n)return n}},t.prototype.addComponent=function(t){this.m_Components.push(t),t.setOwner(this)},t.prototype.addBehaviour=function(t){this.m_Behaviours.push(t),t.setOwner(this)},t.prototype.load=function(){this.m_IsLoaded=!0;for(var t=0,e=this.m_Components;t<e.length;t++)e[t].load();for(var r=0,n=this.m_Children;r<n.length;r++)n[r].load()},t.prototype.update=function(t){this.m_LocalMatrix=this.Transform.getTransformationMatrix(),this.updateWorldMatrix(void 0!==this.m_Parent?this.m_Parent.worldMatrix:void 0);for(var e=0,r=this.m_Components;e<r.length;e++)r[e].update(t);for(var n=0,o=this.m_Behaviours;n<o.length;n++)o[n].update(t);for(var i=0,a=this.m_Children;i<a.length;i++)a[i].update(t)},t.prototype.render=function(t){for(var e=0,r=this.m_Components;e<r.length;e++)r[e].render(t);for(var n=0,o=this.m_Children;n<o.length;n++)o[n].render(t)},t.prototype.updateWorldMatrix=function(t){var e,r;void 0!==t?function(t,e,r){var n=e[0],o=e[1],i=e[2],a=e[3],s=e[4],u=e[5],c=e[6],m=e[7],f=e[8],d=e[9],h=e[10],p=e[11],_=e[12],l=e[13],v=e[14],y=e[15],g=r[0],b=r[1],T=r[2],A=r[3];t[0]=g*n+b*s+T*f+A*_,t[1]=g*o+b*u+T*d+A*l,t[2]=g*i+b*c+T*h+A*v,t[3]=g*a+b*m+T*p+A*y,g=r[4],b=r[5],T=r[6],A=r[7],t[4]=g*n+b*s+T*f+A*_,t[5]=g*o+b*u+T*d+A*l,t[6]=g*i+b*c+T*h+A*v,t[7]=g*a+b*m+T*p+A*y,g=r[8],b=r[9],T=r[10],A=r[11],t[8]=g*n+b*s+T*f+A*_,t[9]=g*o+b*u+T*d+A*l,t[10]=g*i+b*c+T*h+A*v,t[11]=g*a+b*m+T*p+A*y,g=r[12],b=r[13],T=r[14],A=r[15],t[12]=g*n+b*s+T*f+A*_,t[13]=g*o+b*u+T*d+A*l,t[14]=g*i+b*c+T*h+A*v,t[15]=g*a+b*m+T*p+A*y}(this.worldMatrix,t,this.m_LocalMatrix):(e=this.m_WorldMatrix,r=this.m_LocalMatrix,e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15])},t.prototype.onAdded=function(t){this.m_Scene=t},t}();const K=q;const Z=function(){function t(){this.m_RootObj=new K(0,"__ROOT__",this)}return Object.defineProperty(t.prototype,"root",{get:function(){return this.m_RootObj},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isLoaded",{get:function(){return this.m_RootObj.isLoaded},enumerable:!1,configurable:!0}),t.prototype.addObject=function(t){this.m_RootObj.addChild(t)},t.prototype.getObjectByName=function(t){return this.m_RootObj.getObjectByName(t)},t.prototype.load=function(){this.m_RootObj.load()},t.prototype.update=function(t){this.m_RootObj.update(t)},t.prototype.render=function(t){this.m_RootObj.render(t)},t}();var $;!function(t){t[t.UNINITILISED=0]="UNINITILISED",t[t.LOADING=1]="LOADING",t[t.UPDATING=2]="UPDATING"}($||($={}));var tt=function(){function t(t,e,r){this.m_State=$.UNINITILISED,this.m_GlobalId=-1,this.m_Id=t,this.m_Descritpion=r,this.m_Name=e,this.m_Scene=new Z}return Object.defineProperty(t.prototype,"id",{get:function(){return this.m_Id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return this.m_Name},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"description",{get:function(){return this.m_Descritpion},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"scene",{get:function(){return this.m_Scene},enumerable:!1,configurable:!0}),t.prototype.init=function(t){if(void 0===t.objects)throw new Error("Level init error: objects are missing");for(var e in t.objects){var r=t.objects[e];this.loadSimObject(r,this.m_Scene.root)}},t.prototype.load=function(){this.m_State=$.LOADING,this.m_Scene.load(),this.m_State=$.UPDATING},t.prototype.unload=function(){},t.prototype.update=function(t){this.m_State===$.UPDATING&&this.m_Scene.update(t)},t.prototype.render=function(t){this.m_State===$.UPDATING&&this.m_Scene.render(t)},t.prototype.onActivated=function(){},t.prototype.onDeactived=function(){},t.prototype.loadSimObject=function(t,e){var r;void 0!==t.name&&(r=String(t.name)),this.m_GlobalId++;var n=new K(this.m_GlobalId,r,this.m_Scene);if(void 0!==t.transform&&n.Transform.setFromJson(t.transform),void 0!==t.components)for(var o in t.components){var i=t.components[o],a=J.extractComponent(i);n.addComponent(a)}if(void 0!==t.behaviours)for(var s in t.behaviours){i=t.behaviours[s];var u=j.extractBehaviour(i);n.addBehaviour(u)}if(void 0!==t.children)for(var c in t.children){var m=t.children[c];this.loadSimObject(m,n)}void 0!==e&&e.addChild(n)},t}();const et=tt;const rt=function(){function t(){}return t.init=function(){t.m_Instance=new t,t.m_RegisteredLevels[0]="../../assets/levels/testLevel.json"},t.changeLevel=function(e){if(void 0!==t.m_ActiveLevel&&(t.m_ActiveLevel.onDeactived(),t.m_ActiveLevel.unload(),t.m_ActiveLevel=void 0),void 0===t.m_RegisteredLevels[e])throw new Error("Level with id ".concat(e," doesn't exist."));if(p.isAssetLoaded(t.m_RegisteredLevels[e])){var r=p.getAsset(t.m_RegisteredLevels[e]);t.loadLevel(r)}else u.subscribe(h+t.m_RegisteredLevels[e],t.m_Instance),p.loadAsset(t.m_RegisteredLevels[e])},t.update=function(e){void 0!==t.m_ActiveLevel&&t.m_ActiveLevel.update(e)},t.render=function(e){void 0!==t.m_ActiveLevel&&t.m_ActiveLevel.render(e)},t.loadLevel=function(e){var r,n,o,i=e.Data;if(void 0===i.id)throw new Error("Level id missing");if(r=Number(i.id),void 0===i.name)throw new Error("Level name missing");n=String(i.name),void 0!==i.description&&(o=String(i.description)),t.m_ActiveLevel=new et(r,n,o),t.m_ActiveLevel.init(i),t.m_ActiveLevel.onActivated(),t.m_ActiveLevel.load()},t.prototype.onMessage=function(e){if(-1!==e.Code.indexOf(h)){var r=e.Context;console.log("Asset",r),t.loadLevel(r)}},t.m_GlobalLevelId=-1,t.m_RegisteredLevels={},t}(),nt=function(){function r(){}return r.prototype.start=function(){this.m_Canvas=e.init(),p.init(),rt.init(),J.init(),j.init(),t.clearColor(0,0,0,1),this.m_BasicShader=new y,this.m_BasicShader.use(),this.m_Projection=n(),this.m_Projection=o(this.m_Projection,0,this.m_Canvas.width,this.m_Canvas.height,0,-100,100),T.registerMaterial(new E("crate","../assets/textures/crate.jpg",new P(255,128,0,255))),rt.changeLevel(0),this.resize(),this.loop()},r.prototype.resize=function(){void 0!==this.m_Canvas&&(this.m_Canvas.width=window.innerWidth,this.m_Canvas.height=window.innerHeight),t.viewport(0,0,this.m_Canvas.width,this.m_Canvas.height),this.m_Projection=o(this.m_Projection,0,this.m_Canvas.width,this.m_Canvas.height,0,-100,100)},r.prototype.loop=function(){a.update(0),rt.update(0),t.clear(t.COLOR_BUFFER_BIT);var e=this.m_BasicShader.getUniformLocation("u_projection");t.uniformMatrix4fv(e,!1,new Float32Array(this.m_Projection)),rt.render(this.m_BasicShader),requestAnimationFrame(this.loop.bind(this))},r}();var ot;window.onload=function(){(ot=new nt).start()},window.onresize=function(){ot.resize()}})();